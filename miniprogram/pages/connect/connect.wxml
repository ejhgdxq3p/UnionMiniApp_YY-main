<!--connect.wxml-->
<view class="container">
  <!-- ä¸»é¢˜èƒŒæ™¯å›¾ç‰‡ -->
  <view class="theme-background" wx:if="{{cards[currentTrackIndex].avatarUrl}}" style="background-image: url({{cards[currentTrackIndex].avatarUrl}});"></view>
  <!-- èƒŒæ™¯è™šåŒ–å±‚ -->
  <view class="background-blur"></view>
  
  <!-- èƒŒæ™¯æ˜Ÿæ˜Ÿ -->
  <block wx:for="{{stars}}" wx:key="id">
    <view 
      class="star" 
      style="left: {{item.x}}rpx; top: {{item.y}}rpx; width: {{item.size}}rpx; height: {{item.size}}rpx; opacity: {{item.opacity}};"
      data-id="{{item.id}}">
    </view>
  </block>
  
  <!-- è¿æ¥é¡µé¢å†…å®¹ -->
  <view class="content">
    <!-- logoå’Œæ£€ç´¢æ¡†åŒºåŸŸ -->
    <view class="header-area">
      <image class="union-logo" src="/images/uinon logo4.png" mode="aspectFit" bindtap="goToFuzzySearch"></image>
      <view class="search-bar" bindtap="goToFuzzySearch">
        <view class="search-text">{{texts.searchPlaceholder}}</view>
      </view>
      <view class="search-hint" bindtap="goToFuzzySearch">{{texts.searchHint}}</view>
    </view>
    
    <!-- å‘å…‰ç¯åŒºåŸŸ -->
    <view class="glow-orb-container" bindtap="viewTrackDetail" data-index="{{currentTrackIndex}}">
      <view class="glow-orb" style="color: {{currentThemeColor}};">
        <view class="orb-inner-glow"></view>
      </view>
    </view>
    
    <!-- ä¸»é¢˜åˆ—è¡¨ -->
    <scroll-view class="music-playlist" scroll-y="{{false}}" bindtouchstart="touchStart" bindtouchmove="touchMove" bindtouchend="touchEnd">
      <!-- åŠ è½½ä¸­æç¤º -->
      <view class="loading-container" wx:if="{{isLoading}}">
        <view class="loading-icon"></view>
        <text class="loading-text">{{texts.loadingText}}</text>
      </view>
      
      <!-- é”™è¯¯æç¤º -->
      <view class="error-container" wx:elif="{{loadError}}">
        <text class="error-text">{{loadError}}</text>
        <view class="retry-btn" bindtap="initThemeCards">{{texts.retryButton}}</view>
      </view>
      
      <!-- ç©ºçŠ¶æ€æç¤º -->
      <view class="empty-container" wx:elif="{{cards.length === 0}}">
        <view class="empty-icon">ğŸµ</view>
        <text class="empty-text">{{texts.emptyText}}</text>
        <text class="empty-subtext">{{texts.emptySubtext}}</text>
      </view>
      
      <!-- ä¸»é¢˜åˆ—è¡¨ -->
      <view class="playlist-container" wx:else>
        <!-- é¡¶éƒ¨å¡«å…… -->
        <view class="list-padding"></view>
        
        <!-- å®ç°ç‰©ç†æ»šåŠ¨æ•ˆæœçš„è½¨é“ -->
        <view class="track-wheel" style="transform: translateY({{scrollOffset}}rpx)">
          <view class="track-item {{index === currentTrackIndex ? 'active' : ''}}" 
                wx:for="{{cards}}" 
                wx:key="index"
                style="opacity: {{1 - 0.12 * Math.abs(index - currentTrackIndex)}};"
                data-index="{{index}}"
                bindtap="viewTrackDetail">
            <!-- å¤§å‹ä¸“è¾‘å°é¢å¼å¤´åƒ -->
            <view class="album-cover-container">
              <view class="album-cover-placeholder" wx:if="{{!item.avatarUrl}}" style="background-color: {{item.color || '#6366f1'}}">
                <text>{{item.name ? item.name[0] : '?'}}</text>
              </view>
              <image class="album-cover" wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" mode="aspectFill"></image>
            </view>
            
            <view class="track-info">
              <view class="track-title">{{item.name || texts.unknownTheme}}</view>
              <view class="track-artist">{{item.subtitle || item.theme || texts.unknownTheme}}</view>
              
              <!-- ä¸»é¢˜ç‰¹è‰²ä½œä¸ºæ ‡ç­¾ -->
              <view class="track-tags" wx:if="{{item.details && item.details.features && item.details.features.length > 0}}">
                <view class="tag" wx:for="{{item.details.features}}" wx:for-item="feature" wx:key="*this" wx:if="{{index < 2}}">
                  {{feature}}
                </view>
                <view class="tag-more" wx:if="{{item.details.features.length > 2}}">+{{item.details.features.length - 2}}</view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- åº•éƒ¨å¡«å…… -->
        <view class="list-padding"></view>
      </view>
    </scroll-view>

    <!-- é…å¯¹ç”¨æˆ·å±•ç¤ºåŒº -->
    <view class="pair-section" wx:if="{{myPairs.length > 0}}">
      <view class="pair-title">{{texts.pairingTitle}}</view>
      <view class="pair-list">
        <block wx:for="{{myPairs}}" wx:key="_openid">
          <view class="pair-user" bindtap="showPairModal" data-openid="{{item._openid}}">
            <view class="pair-user-container">
              <image class="pair-avatar" src="{{item.avatarUrl || '/assets/default-avatar.png'}}" mode="aspectFill"></image>
              <view class="pair-tap-hint" style="border-color: {{currentThemeColor}}; color: {{currentThemeColor}};">
                <text class="tap-text">{{texts.tapHint}}</text>
              </view>
            </view>
            <view class="pair-nickname">{{item.nickName || texts.unknownUser}}</view>
          </view>
        </block>
      </view>
    </view>

    <!-- é…å¯¹ç†ç”±å¼¹çª— -->
    <view class="pair-modal" wx:if="{{showPairModal}}">
      <view class="pair-modal-mask" bindtap="closePairModal"></view>
      <view class="pair-modal-content">
        <view class="pair-modal-close" bindtap="closePairModal">Ã—</view>
        <view class="pair-modal-header">
          <image class="pair-modal-avatar" src="{{pairModalUser.avatarUrl || '/assets/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="pair-modal-nickname">{{pairModalUser.nickName || texts.unknownUser}}</view>
        </view>
        <view class="pair-modal-reason-title">{{texts.modalTitle}}</view>
        <view class="pair-modal-reason">{{pairModalContent}}</view>
      </view>
    </view>
  </view>
  
  <!-- ç¤¾ç¾¤æˆå‘˜é¢„è§ˆå¼¹çª— -->
  <view class="card-preview-modal" wx:if="{{showCardPreview}}">
    <view class="card-preview-content">
      <view class="card-preview-close" bindtap="closeCardPreview">Ã—</view>
      <view class="business-card">
        <!-- å›ºå®šå¤´éƒ¨åŒºåŸŸ -->
        <view class="card-header">
          <image class="card-avatar" src="{{selectedCard.avatarUrl || '/assets/default-avatar.png'}}"></image>
          <view class="card-basic-info">
            <view class="card-name">{{selectedCard.name || texts.unknownTheme}}</view>
                          <view class="card-position">{{selectedCard.communityName || texts.unknownCommunity}}</view>
                          <view class="card-organization">{{texts.memberCount ? texts.memberCount.replace('{total}', selectedCard.totalMembers || 0).replace('{other}', selectedCard.otherMembersCount || 0) : 'å…±' + (selectedCard.totalMembers || 0) + 'äººï¼Œå…¶ä»–æˆå‘˜' + (selectedCard.otherMembersCount || 0) + 'äºº'}}</view>
          </view>
        </view>
        <view class="card-divider"></view>
        
        <!-- å¯æ»šåŠ¨çš„å†…å®¹åŒºåŸŸ -->
        <scroll-view class="card-body-scroll" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
          <view class="card-body">
            <view class="card-intro">{{selectedCard.communityDescription || texts.noDescription}}</view>
            
            <!-- ç¤¾ç¾¤æˆå‘˜ç®€æ˜“åç‰‡åˆ—è¡¨ -->
            <view class="card-members" wx:if="{{selectedCard.pairedUsers && selectedCard.pairedUsers.length > 0}}">
              <view class="card-section-title">{{texts.sectionTitle}}</view>
              <view class="member-cards-list">
                <view 
                  wx:for="{{selectedCard.pairedUsers}}" 
                  wx:key="openid"
                  class="member-mini-card"
                  bindtap="showDetailedCard"
                  data-member-index="{{index}}">
                  <view class="member-avatar-container">
                    <image class="member-mini-avatar" src="{{item.userInfo.avatarUrl || '/assets/default-avatar.png'}}" mode="aspectFill"></image>
                    <view class="member-tap-hint" style="border-color: {{currentThemeColor}}; color: {{currentThemeColor}};">
                      <text class="member-tap-text">ç¢°</text>
                    </view>
                  </view>
                  <view class="member-mini-info">
                    <view class="member-mini-name">{{item.userInfo.nickName || texts.unknownUser}}</view>
                    <view class="member-mini-status">{{texts.memberStatus}}</view>
                  </view>
                  <view class="member-mini-arrow">></view>
                </view>
              </view>
              <!-- æ»šåŠ¨æç¤º -->
              <view class="scroll-hint" wx:if="{{selectedCard.pairedUsers.length > 4}}">
                <text class="scroll-hint-text">{{texts.scrollHint}}</text>
              </view>
            </view>

            <!-- ç¤¾ç¾¤ç‰¹å¾æ ‡ç­¾ -->
            <view class="card-skills" wx:if="{{selectedCard.details && selectedCard.details.features && selectedCard.details.features.length > 0}}">
              <view class="card-section-title">{{texts.featuresTitle}}</view>
              <view class="card-tags">
                <view class="card-tag" wx:for="{{selectedCard.details.features}}" wx:key="index">{{item}}</view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- è¯¦ç»†åç‰‡å¼¹çª— -->
  <view class="detailed-card-modal" wx:if="{{showDetailedCard}}">
    <view class="detailed-card-mask" bindtap="closeDetailedCard"></view>
    <view class="detailed-card-content">
      <view class="detailed-card-close" bindtap="closeDetailedCard">Ã—</view>
      
      <!-- è¯¦ç»†åç‰‡å¤´éƒ¨ -->
      <view class="detailed-card-header">
        <view class="detailed-card-avatar-container">
          <image class="detailed-card-avatar" src="{{selectedMember.userInfo.avatarUrl || '/assets/default-avatar.png'}}" mode="aspectFill"></image>
          <view class="detailed-card-tap-hint" style="border-color: {{currentThemeColor}}; color: {{currentThemeColor}};">
            <text class="detailed-tap-text">ç¢°</text>
          </view>
        </view>
        <view class="detailed-card-info">
          <view class="detailed-card-name">{{selectedMember.userInfo.nickName || texts.unknownUser}}</view>
          <view class="detailed-card-status">{{texts.memberStatus}}</view>
          <view class="detailed-card-theme">{{selectedCard.name || texts.unknownTheme}} Â· {{selectedCard.communityName || texts.unknownCommunity}}</view>
        </view>
      </view>
      
      <view class="detailed-card-divider"></view>
      
      <!-- è¯¦ç»†åç‰‡å†…å®¹ -->
      <scroll-view class="detailed-card-body-scroll" scroll-y="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}">
        <view class="detailed-card-body">
          <!-- ä¸ªäººç®€ä»‹ -->
          <view class="card-section">
            <view class="card-section-title">ä¸ªäººç®€ä»‹</view>
            <view class="card-intro-text">è¿™æ˜¯ä¸€ä½{{selectedCard.communityName || 'ç¥ç§˜ç¤¾ç¾¤'}}çš„æ´»è·ƒæˆå‘˜ï¼Œä¸ä½ åœ¨{{selectedCard.name || 'ç›¸åŒä¸»é¢˜'}}ä¸‹ç›¸é‡ã€‚</view>
          </view>
          
          <!-- å…±åŒæ ‡ç­¾ -->
          <view class="card-section" wx:if="{{selectedCard.details && selectedCard.details.features && selectedCard.details.features.length > 0}}">
            <view class="card-section-title">å…±åŒæ ‡ç­¾</view>
            <view class="card-tags-grid">
              <view class="card-tag-item" wx:for="{{selectedCard.details.features}}" wx:key="index" wx:if="{{index < 6}}">
                {{item}}
              </view>
            </view>
          </view>
          
          <!-- AIåŒ¹é…ç†ç”± -->
          <view class="card-section">
            <view class="card-section-title">AIåŒ¹é…ç†ç”±</view>
            <view class="match-reason-card">
              <view class="match-reason-content" wx:if="{{selectedMember.matchReason}}">
                {{selectedMember.matchReason}}
              </view>
              <view class="match-reason-loading" wx:elif="{{selectedMember.isGeneratingReason}}">
                <view class="loading-dots">
                  <view class="dot"></view>
                  <view class="dot"></view>
                  <view class="dot"></view>
                </view>
                <text>AIæ­£åœ¨åˆ†æä½ ä»¬çš„åŒ¹é…åº¦...</text>
              </view>
              <view class="match-reason-placeholder" wx:else>
                AIæ­£åœ¨ä¸ºä½ ä»¬é‡èº«å®šåˆ¶åŒ¹é…ç†ç”±...
              </view>
            </view>
          </view>
          
          <!-- æ“ä½œæŒ‰é’® -->
          <view class="card-actions">
            <view class="action-btn primary" bindtap="sendMessage" data-openid="{{selectedMember.openid}}">
              <text>å‘é€æ¶ˆæ¯</text>
            </view>
            <view class="action-btn secondary" bindtap="viewCommunity">
              <text>æŸ¥çœ‹ç¤¾ç¾¤</text>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view> 