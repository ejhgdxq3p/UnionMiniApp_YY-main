/**
 * è¿æ¥é¡µé¢ - connect.js
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * 1. é»‘èƒ¶å”±ç‰‡é£æ ¼çš„ä¸»é¢˜æµè§ˆç•Œé¢
 * 2. å››ä¸ªä¸»é¢˜å¡ç‰‡åˆ—è¡¨ï¼Œæ”¯æŒæ»‘åŠ¨åˆ‡æ¢
 * 3. æ”¯æŒè§¦æ‘¸æ»‘åŠ¨ã€æƒ¯æ€§æ»šåŠ¨å’ŒæŒ¯åŠ¨åé¦ˆ
 * 4. ä¸»é¢˜è¯¦æƒ…æŸ¥çœ‹å’Œä»‹ç»å±•ç¤º
 * 
 * äº¤äº’è®¾è®¡è¦ç‚¹ï¼š
 * - å”±ç‰‡æ—‹è½¬åŠ¨ç”»ï¼šæ¨¡æ‹Ÿé»‘èƒ¶å”±ç‰‡æ’­æ”¾æ•ˆæœ
 * - å¡ç‰‡æ»šåŠ¨ä¸ç¼©æ”¾ï¼šæ»‘åŠ¨æ—¶å®ç°å¡ç‰‡æ”¾å¤§èšç„¦è§†è§‰æ•ˆæœ
 * - è§¦æ‘¸æŒ¯åŠ¨åé¦ˆï¼šæ»‘åŠ¨åˆ‡æ¢å¡ç‰‡æ—¶æä¾›è½»å¾®æŒ¯åŠ¨
 * - æƒ¯æ€§æ»šåŠ¨æ•ˆæœï¼šæ ¹æ®æ»‘åŠ¨é€Ÿåº¦å®ç°è‡ªç„¶çš„æƒ¯æ€§æ»‘åŠ¨
 * - å¡ç‰‡ä½ç½®åç§»ï¼šå°†é€‰ä¸­çš„å¡ç‰‡ä½ç½®ä¼˜åŒ–åˆ°è§†è§‰ä¸­å¿ƒ
 * 
 * ä¿®æ”¹å†å²ï¼š
 * 1. ä¼˜åŒ–äº†å¡ç‰‡æ˜¾ç¤ºæ ·å¼ï¼Œä½¿å¡ç‰‡æ›´å¤§æ›´é†’ç›®
 * 2. å°†å¤´åƒæ”¹ä¸ºæ–¹å½¢ï¼Œç±»ä¼¼é»‘èƒ¶å”±ç‰‡çš„ä¸“è¾‘å°é¢
 * 3. ç§»é™¤äº†é€‰æ‹©æŒ‡ç¤ºå™¨ï¼Œç®€åŒ–ç•Œé¢
 * 4. ä¼˜åŒ–äº†æ»šåŠ¨ä½“éªŒï¼Œæå‡ç”¨æˆ·äº¤äº’æ„Ÿ
 * 5. å°†ç”¨æˆ·åç‰‡æ”¹ä¸ºå››ä¸ªä¸»é¢˜å±•ç¤º
 */

// miniprogram/pages/connect/connect.js
Page({

  /**
   * Page initial data
   */
  data: {
    arcPosition: 0,         // å¼§å½¢ä½ç½®å‚æ•°
    notesHeight: 120,       // æ³¨é‡ŠåŒºåŸŸé«˜åº¦
    minNotesHeight: 200,    // æœ€å°æ³¨é‡ŠåŒºåŸŸé«˜åº¦
    maxNotesHeight: 1200,   // æœ€å¤§æ³¨é‡ŠåŒºåŸŸé«˜åº¦
    isExpanded: false,      // æ˜¯å¦å±•å¼€æ³¨é‡ŠåŒºåŸŸ
    startY: 0,              // è§¦æ‘¸èµ·å§‹Yåæ ‡
    lastY: 0,               // ä¸Šæ¬¡è§¦æ‘¸Yåæ ‡
    moveDirection: '',      // ç§»åŠ¨æ–¹å‘
    moveSpeed: 0,           // ç§»åŠ¨é€Ÿåº¦
    canScroll: false,       // æ˜¯å¦å¯ä»¥æ»šåŠ¨
    isDragging: false,      // æ˜¯å¦æ­£åœ¨æ‹–åŠ¨
    cards: [],              // ä¸»é¢˜å¡ç‰‡æ•°æ®
    isLoading: false,       // æ˜¯å¦æ­£åœ¨åŠ è½½
    loadError: '',          // åŠ è½½é”™è¯¯ä¿¡æ¯
    notes: [                // æ³¨é‡Šæ•°æ®
      { id: 1, title: 'æ—¶é—´çš„ä½¿ç”¨è€…', content: 'æ¢ç´¢æ—¶é—´ç®¡ç†ä¸ç”Ÿæ´»èŠ‚å¥çš„è‰ºæœ¯' },
      { id: 2, title: 'æ„Ÿå®˜äº¤ç•Œ', content: 'ä½“éªŒå¤šæ„Ÿå®˜èåˆçš„å¥‡å¦™ä¸–ç•Œ' },
      { id: 3, title: 'æœªæ¥æ¢ç´¢æ´¾', content: 'ç•…æƒ³ç§‘æŠ€ä¸äººæ–‡çš„æœªæ¥å›¾æ™¯' },
      { id: 4, title: 'æ¢ç´¢äººæ ¼åšå¼ˆé¦†', content: 'æ·±å…¥äº†è§£äººæ ¼ç±»å‹ä¸ç¤¾äº¤åŠ¨æ€' }
    ],
    linkBall1Angle: -60,    // è¿æ¥çƒ1è§’åº¦
    linkBall2Angle: 30,     // è¿æ¥çƒ2è§’åº¦
    linkBall3Angle: 270,    // è¿æ¥çƒ3è§’åº¦
    discRotation: 0,        // å”±ç‰‡æ—‹è½¬è§’åº¦
    currentTrackIndex: 0,   // å½“å‰é€‰ä¸­çš„ä¸»é¢˜ç´¢å¼•
    startTouchY: 0,         // è§¦æ‘¸å¼€å§‹Yåæ ‡
    lastTouchY: 0,          // ä¸Šæ¬¡è§¦æ‘¸Yåæ ‡
    scrollDistance: 0,      // æ»šåŠ¨è·ç¦»
    scrollOffset: 0,        // æ»šåŠ¨åç§»é‡
    itemHeight: 310,        // å¡ç‰‡é«˜åº¦
    touchStartTime: 0,      // è§¦æ‘¸å¼€å§‹æ—¶é—´
    touchEndTime: 0,        // è§¦æ‘¸ç»“æŸæ—¶é—´
    touchVelocity: 0,       // è§¦æ‘¸æ»‘åŠ¨é€Ÿåº¦
    isScrolling: false,     // æ˜¯å¦æ­£åœ¨æ»šåŠ¨
    inertiaAnimationId: null, // æƒ¯æ€§åŠ¨ç”»ID
    isInertiaScrolling: false, // æ˜¯å¦æ­£åœ¨æƒ¯æ€§æ»šåŠ¨
    showCardPreview: false, // æ˜¯å¦æ˜¾ç¤ºä¸»é¢˜é¢„è§ˆ
    selectedCard: {},       // é€‰ä¸­çš„ä¸»é¢˜æ•°æ®
    stars: [],              // èƒŒæ™¯æ˜Ÿæ˜Ÿæ•°ç»„
    connections: [],        // ç¤¾äº¤è¿æ¥æ•°æ®
    loading: false,         // æ˜¯å¦æ­£åœ¨åŠ è½½
    cardPositionOffset: 200, // å¡ç‰‡ä½ç½®åç§»é‡
    pairResults: {},        // å­˜å‚¨æ¯ä¸ªä¸»é¢˜ä¸‹çš„é…å¯¹ç»“æœ { themeId: [{users: [userA, userB], reason: "..."}, ...] }
    myPairs: [],            // å½“å‰ç”¨æˆ·åœ¨å½“å‰ä¸»é¢˜ä¸‹çš„é…å¯¹å¯¹è±¡
    myPairReasons: {},      // å½“å‰ç”¨æˆ·ä¸é…å¯¹å¯¹è±¡çš„ç†ç”± { openid: reason }
    showPairModal: false,    // æ˜¯å¦æ˜¾ç¤ºé…å¯¹ç†ç”±å¼¹çª—
    pairModalContent: '',    // é…å¯¹ç†ç”±å†…å®¹
    pairModalUser: null,     // å½“å‰å¼¹çª—çš„é…å¯¹ç”¨æˆ·
    // æ–°å¢ï¼šç¤¾ç¾¤åˆ†ç±»ç›¸å…³æ•°æ®
    classificationData: [], // class_baræ•°æ®åº“çš„å®Œæ•´åˆ†ç±»æ•°æ®
    currentUserOpenid: '',  // å½“å‰ç”¨æˆ·çš„openid
    themeCommunitiesData: {}, // å½“å‰ä¸»é¢˜ä¸‹çš„ç¤¾ç¾¤æ•°æ®
    currentUserCommunity: null, // å½“å‰ç”¨æˆ·æ‰€åœ¨çš„ç¤¾ç¾¤
    communityMembers: [],    // å½“å‰ç”¨æˆ·ç¤¾ç¾¤çš„å…¶ä»–æˆå‘˜
    // ç…§æŠ„briefingé¡µé¢çš„æˆåŠŸæ•°æ®ç»“æ„
    classifications: [],     // briefingé¡µé¢çš„åˆ†ç±»æ•°æ®ç»“æ„
    currentUserOpenId: '',   // briefingé¡µé¢çš„openidå­—æ®µ
    // è¯¦ç»†åç‰‡ç›¸å…³æ•°æ®
    showDetailedCard: false, // æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†åç‰‡å¼¹çª—
    selectedMember: {},      // é€‰ä¸­çš„æˆå‘˜æ•°æ®
    // é…å¯¹ç›¸å…³æ•°æ®
    hasPairedUsers: false,   // æ˜¯å¦å·²æœ‰é…å¯¹ç”¨æˆ·
    pairType: '',           // é…å¯¹ç±»å‹ï¼š'å·²é…å¯¹', 'AIé…å¯¹', 'ç¤¾ç¾¤æˆå‘˜'
    pairReason: ''          // é…å¯¹ç†ç”±
  },

  /**
   * Lifecycle function--Called when page load
   */
  onLoad(options) {
    // åˆå§‹åŒ–è®¾ç½®å‘ä¸Šåç§»é‡
    this.setData({
      cardPositionOffset: -200, // å‘ä¸Šåç§»200rpxï¼Œä½¿ç”¨è´Ÿå€¼
      scrollOffset: -200 // è®¾ç½®åˆå§‹æ»šåŠ¨ä½ç½®ï¼Œä¸åç§»é‡ä¿æŒä¸€è‡´
    });
    
    this.initThemeCards();
    this.generateStars();
    this.initAnimation();
    
    // ã€ç…§æŠ„briefingæˆåŠŸæ–¹æ¡ˆã€‘ç›´æ¥è°ƒç”¨åˆ†ç±»å‡½æ•°ï¼Œå®ƒä¼šå¤„ç†æ‰€æœ‰åç»­é€»è¾‘
    this.classifyUsers();
  },

  /**
   * Lifecycle function--Called when page is initially rendered
   */
  onReady() {
    // æ·»åŠ å‘ä¸Šåç§»é‡ï¼Œä½¿é€‰ä¸­çš„å¡ç‰‡ä½ç½®æ›´é ä¸Š
    this.setData({
      cardPositionOffset: -200 // å‘ä¸Šåç§»200rpx
    });
  },

  /**
   * Lifecycle function--Called when page show
   */
  onShow() {
    if (typeof this.getTabBar === 'function' && this.getTabBar()) {
      this.getTabBar().updateSelected('/pages/connect/connect');
    }
    if (!this.rotationTimer) {
      this.startDiscRotation();
    }
  },

  /**
   * Lifecycle function--Called when page hide
   */
  onHide() {
    this.clearAllTimers();
  },

  /**
   * Lifecycle function--Called when page unload
   */
  onUnload() {
    this.clearAllTimers();
  },

  /**
   * Page event handler function--Called when user drop down
   */
  onPullDownRefresh() {

  },

  /**
   * Called when page reach bottom
   */
  onReachBottom() {

  },

  /**
   * Called when user click on the top right corner to share
   */
  onShareAppMessage() {

  },

  /**
   * æ¸…é™¤æ‰€æœ‰è®¡æ—¶å™¨
   */
  clearAllTimers: function() {
    if (this.rotationTimer) {
      clearInterval(this.rotationTimer);
      this.rotationTimer = null;
    }
    if (this.scrollAnimationTimer) {
      clearTimeout(this.scrollAnimationTimer);
      this.scrollAnimationTimer = null;
    }
  },

  /**
   * å”±ç‰‡æ—‹è½¬åŠ¨ç”»
   */
  startDiscRotation: function() {
    let rotation = this.data.discRotation || 0;
    
    this.rotationTimer = setInterval(() => {
      rotation += 0.5; // æ¯æ¬¡æ—‹è½¬0.5åº¦
      
      this.setData({
        discRotation: rotation
      });
    }, 50); // æ¯50msæ‰§è¡Œä¸€æ¬¡
  },

  // è·³è½¬åˆ°è¿æ¥å›¾è°±é¡µé¢
  goToConnectionMap: function() {
    wx.navigateTo({
      url: '/pages/connectionMap/connectionMap'
    });
  },

  // è·³è½¬åˆ°æˆå°±ç³»ç»Ÿé¡µé¢
  goToAchievements: function() {
    wx.navigateTo({
      url: '/pages/achievements/achievements'
    });
  },

  // è·³è½¬åˆ°ç¤¾ç¾¤æŠ¥å‘Šé¡µé¢
  goToFuzzySearch: function() {
    // è·å–å½“å‰é€‰ä¸­çš„ä¸»é¢˜ä¿¡æ¯
    const currentCard = this.data.cards[this.data.currentTrackIndex];
    const currentTheme = currentCard ? currentCard.name : '';
    const themeIndex = this.data.currentTrackIndex;
    
    console.log('å½“å‰é€‰ä¸­çš„ä¸»é¢˜:', currentTheme, 'ç´¢å¼•:', themeIndex);
    
    wx.navigateTo({
      url: `/pages/briefing/briefing?theme=${encodeURIComponent(currentTheme)}&themeIndex=${themeIndex}`,
      fail: function(err) {
        console.error('è·³è½¬å¤±è´¥:', err);
        wx.showToast({
          title: 'é¡µé¢è·³è½¬å¤±è´¥',
          icon: 'none'
        });
      }
    });
  },

  /**
   * è§¦æ‘¸å¼€å§‹äº‹ä»¶
   */
  touchStart: function(e) {
    // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„æƒ¯æ€§æ»šåŠ¨
    if (this.data.inertiaAnimationId) {
      cancelAnimationFrame(this.data.inertiaAnimationId);
      this.setData({
        isInertiaScrolling: false,
        inertiaAnimationId: null
      });
    }
    
    const touch = e.touches[0];
    this.setData({
      startTouchY: touch.clientY,
      lastTouchY: touch.clientY,
      touchStartTime: Date.now(),
      isScrolling: true,
      isDragging: true
    });
  },

  /**
   * æ·»åŠ æŒ¯åŠ¨åé¦ˆå‡½æ•°
   */
  vibrateFeedback: function() {
    // è°ƒç”¨å¾®ä¿¡å°ç¨‹åºæŒ¯åŠ¨API
    wx.vibrateShort({
      type: 'light' // è½»å¾®æŒ¯åŠ¨ï¼Œé€‚ç”¨äºå¾®ä¿¡å°ç¨‹åºåŸºç¡€åº“ 2.13.0 åŠä»¥ä¸Šç‰ˆæœ¬
    }).catch(error => {
      // å¦‚æœlightç±»å‹ä¸æ”¯æŒï¼Œå›é€€åˆ°é»˜è®¤æŒ¯åŠ¨
      if (error) {
        wx.vibrateShort().catch(() => {
          // å¿½ç•¥ä¸æ”¯æŒæŒ¯åŠ¨çš„è®¾å¤‡é”™è¯¯
          console.log('è®¾å¤‡ä¸æ”¯æŒæŒ¯åŠ¨');
        });
      }
    });
  },

  /**
   * è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
   */
  touchMove: function(e) {
    if (!this.data.isScrolling) return;
    
    const touch = e.touches[0];
    const currentY = touch.clientY;
    const deltaY = currentY - this.data.lastTouchY;
    
    // è®¡ç®—æ»šåŠ¨åç§»é‡ - é™ä½æ»šåŠ¨çµæ•åº¦ï¼Œä½¿æ»‘åŠ¨ä¸è‡³äºå¤ªå¿«
    const moveRate = 0.8; // è¿›ä¸€æ­¥é™ä½æ»šåŠ¨çµæ•åº¦
    const scrollDelta = deltaY * moveRate;
    let newScrollOffset = this.data.scrollOffset + scrollDelta;
    
    // è®¡ç®—å½“å‰åº”è¯¥é€‰ä¸­çš„å¡ç‰‡ç´¢å¼•
    const itemCount = this.data.cards.length;
    if (itemCount > 0) {
      // æ·»åŠ å‘ä¸Šåç§»é‡
      const cardPositionOffset = this.data.cardPositionOffset || -200; // é»˜è®¤å€¼ä¸º-200rpx
      
      // æ·»åŠ è¾¹ç•Œé™åˆ¶ï¼Œé˜²æ­¢æ— é™æ»šåŠ¨
      const maxOffset = 0 + cardPositionOffset; // é¡¶éƒ¨è¾¹ç•Œ(åŠ ä¸Šåç§»é‡)
      const minOffset = -(itemCount - 1) * this.data.itemHeight + cardPositionOffset; // åº•éƒ¨è¾¹ç•Œ(åŠ ä¸Šåç§»é‡)
      
      // é™åˆ¶æ»šåŠ¨èŒƒå›´
      if (newScrollOffset > maxOffset) {
        // æ·»åŠ é˜»å°¼æ•ˆæœï¼Œä½¿è¶…å‡ºè¾¹ç•Œå˜å¾—å›°éš¾
        newScrollOffset = maxOffset + (newScrollOffset - maxOffset) * 0.2;
      } else if (newScrollOffset < minOffset) {
        // æ·»åŠ é˜»å°¼æ•ˆæœï¼Œä½¿è¶…å‡ºè¾¹ç•Œå˜å¾—å›°éš¾
        newScrollOffset = minOffset + (newScrollOffset - minOffset) * 0.2;
      } else {
        // åœ¨æ­£å¸¸èŒƒå›´å†…ï¼Œæ·»åŠ è½»å¾®ç£å¸æ•ˆæœ
        // è®¡ç®—æœ€æ¥è¿‘çš„é¡¹ç›®ä¸­å¿ƒ
        const closestIndex = Math.round(-(newScrollOffset - cardPositionOffset) / this.data.itemHeight);
        const snapPoint = -closestIndex * this.data.itemHeight + cardPositionOffset;
        const distanceToSnap = Math.abs(newScrollOffset - snapPoint);
        
        // å½“æ¥è¿‘ç£å¸ç‚¹æ—¶ï¼Œè½»å¾®å¸å¼•
        const snapThreshold = this.data.itemHeight * 0.15;
        if (distanceToSnap < snapThreshold) {
          // é è¿‘ç£å¸ç‚¹æ—¶ï¼Œè½»å¾®æ‹‰å‘ç£å¸ç‚¹
          const snapStrength = 0.3 * (1 - distanceToSnap / snapThreshold);
          newScrollOffset = newScrollOffset + (snapPoint - newScrollOffset) * snapStrength;
        }
      }
      
      // æ ¹æ®åç§»é‡è®¡ç®—ç´¢å¼•(å‡å»åç§»é‡åè®¡ç®—)
      let newIndex = Math.round(-(newScrollOffset - cardPositionOffset) / this.data.itemHeight);
      
      // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
      newIndex = Math.max(0, Math.min(newIndex, itemCount - 1));
      
      // è®°å½•å½“å‰ç´¢å¼•ç”¨äºæ¯”è¾ƒ
      const oldIndex = this.data.currentTrackIndex;
      
      // æ›´æ–°æ•°æ®
      this.setData({
        scrollOffset: newScrollOffset,
        lastTouchY: currentY,
        currentTrackIndex: newIndex
      });
      
      // å¦‚æœç´¢å¼•å˜åŒ–ï¼Œè§¦å‘æŒ¯åŠ¨åé¦ˆå¹¶åŒæ­¥ä¸»é¢˜åˆ°å…¨å±€
      if (newIndex !== oldIndex) {
        this.vibrateFeedback();
        this.syncThemeToGlobal(newIndex);
      }
    } else {
      this.setData({
        scrollOffset: newScrollOffset,
        lastTouchY: currentY
      });
    }
  },
  
  /**
   * å¤„ç†å¾ªç¯æ»šåŠ¨çš„ç´¢å¼•è®¡ç®—
   */
  normalizeIndex: function(index, count) {
    if (count === 0) return 0;
    // å¾ªç¯æ»šåŠ¨ï¼šå½“ç´¢å¼•å°äº0æ—¶ï¼Œä»åˆ—è¡¨æœ«å°¾å¼€å§‹ï¼›å½“ç´¢å¼•å¤§äºç­‰äºcountæ—¶ï¼Œä»åˆ—è¡¨å¼€å¤´å¼€å§‹
    while (index < 0) {
      index += count;
    }
    return index % count;
  },

  /**
   * è§¦æ‘¸ç»“æŸäº‹ä»¶
   */
  touchEnd: function(e) {
    if (!this.data.isScrolling) return;
    
    const touchEndTime = Date.now();
    const touchDuration = touchEndTime - this.data.touchStartTime;
    
    // è®¡ç®—æ»‘åŠ¨é€Ÿåº¦ (åƒç´ /æ¯«ç§’)
    const touchDistance = this.data.lastTouchY - this.data.startTouchY;
    const velocity = touchDistance / touchDuration;
    
    // è®¾ç½®ç»“æŸçŠ¶æ€
    this.setData({
      isScrolling: false,
      touchEndTime: touchEndTime,
      touchVelocity: velocity,
      isDragging: false
    });
    
    // å¦‚æœæ»‘åŠ¨é€Ÿåº¦å¾ˆå¿«ï¼Œæ‰ä½¿ç”¨æƒ¯æ€§æ»šåŠ¨ï¼Œæé«˜é€Ÿåº¦é˜ˆå€¼
    if (Math.abs(velocity) > 0.2) {
      // å¤„ç†ç‰©ç†æƒ¯æ€§æ»šåŠ¨
      this.handleInertiaScroll(velocity);
    } else {
      // é€Ÿåº¦è¾ƒæ…¢ï¼Œç›´æ¥å¯¹é½åˆ°æœ€è¿‘çš„é¡¹ç›®
      this.snapToClosestItem();
    }
  },
  
  /**
   * å¤„ç†æƒ¯æ€§æ»šåŠ¨
   */
  handleInertiaScroll: function(initialVelocity) {
    // æ»šåŠ¨é€Ÿåº¦å¤ªå°åˆ™ä¸å¯ç”¨æƒ¯æ€§
    if (Math.abs(initialVelocity) < 0.05) {
      this.snapToClosestItem();
      return;
    }
    
    // æƒ¯æ€§å‚æ•° - å¢åŠ å‡é€Ÿåº¦ï¼Œä½¿æ»‘åŠ¨æ›´å¿«åœä¸‹æ¥
    const deceleration = 0.004; // å¢åŠ å‡é€Ÿåº¦
    let velocity = initialVelocity * 15; // è¿›ä¸€æ­¥é™ä½åˆå§‹é€Ÿåº¦ç³»æ•°
    let scrollOffset = this.data.scrollOffset;
    const itemCount = this.data.cards.length;
    const cardPositionOffset = this.data.cardPositionOffset || -200; // é»˜è®¤å€¼ä¸º-200rpx
    
    // è®°å½•ä¸Šä¸€ä¸ªç´¢å¼•ï¼Œç”¨äºæ£€æµ‹å˜åŒ–
    let lastIndex = this.data.currentTrackIndex;
    
    // è®¾ç½®æƒ¯æ€§æ»šåŠ¨çŠ¶æ€
    this.setData({
      isInertiaScrolling: true
    });
    
    // ä½¿ç”¨å®šæ—¶å™¨æ›¿ä»£requestAnimationFrame
    const animate = () => {
      if (!this.data.isInertiaScrolling) return;
      
      if (Math.abs(velocity) > 0.1) {
        // å‡é€Ÿ
        const direction = velocity > 0 ? 1 : -1;
        velocity -= direction * deceleration * 16; // å‡è®¾16msä¸ºä¸€å¸§
        
        // è®¡ç®—æ»šåŠ¨åç§»
        const delta = velocity * 16;
        scrollOffset += delta;
        
        // æ£€æŸ¥è¾¹ç•Œ
        if (scrollOffset > 0 + cardPositionOffset) {
          scrollOffset = 0 + cardPositionOffset;
          velocity = 0; // åˆ°è¾¾é¡¶éƒ¨è¾¹ç•Œï¼Œåœæ­¢æƒ¯æ€§
        } else if (scrollOffset < -(itemCount - 1) * this.data.itemHeight + cardPositionOffset) {
          scrollOffset = -(itemCount - 1) * this.data.itemHeight + cardPositionOffset;
          velocity = 0; // åˆ°è¾¾åº•éƒ¨è¾¹ç•Œï¼Œåœæ­¢æƒ¯æ€§
        }
        
        // è®¡ç®—å½“å‰åº”è¯¥é€‰ä¸­çš„å¡ç‰‡ç´¢å¼•
        if (itemCount > 0) {
          let newIndex = Math.round(-(scrollOffset - cardPositionOffset) / this.data.itemHeight);
          
          // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
          newIndex = Math.max(0, Math.min(newIndex, itemCount - 1));
          
          // å¢å¼ºç£å¸æ•ˆæœ - å½“æ¥è¿‘æŸä¸ªé€‰é¡¹çš„ä¸­å¿ƒç‚¹æ—¶ï¼Œå¢åŠ å‡é€Ÿ
          const itemCenter = -newIndex * this.data.itemHeight + cardPositionOffset;
          const distanceToCenter = Math.abs(scrollOffset - itemCenter);
          const magnetThreshold = this.data.itemHeight * 0.4; // ç£å¸èŒƒå›´
          
          if (distanceToCenter < magnetThreshold) {
            // è·ç¦»ä¸­å¿ƒç‚¹è¶Šè¿‘ï¼Œå‡é€Ÿè¶Šæ˜æ˜¾
            const magnetStrength = 1 - (distanceToCenter / magnetThreshold);
            velocity *= (1 - (magnetStrength * 0.3)); // ä½¿ç”¨ç£å¸å¼ºåº¦å‡é€Ÿ
            
            // å¦‚æœé€Ÿåº¦å¾ˆå°ä¸”éå¸¸æ¥è¿‘ä¸­å¿ƒç‚¹ï¼Œç›´æ¥å¯¹é½å¹¶åœæ­¢
            if (Math.abs(velocity) < 0.5 && distanceToCenter < this.data.itemHeight * 0.1) {
              this.setData({
                scrollOffset: itemCenter,
                currentTrackIndex: newIndex,
                isInertiaScrolling: false
              });
              return;
            }
          }
          
          // æ£€æµ‹ç´¢å¼•æ˜¯å¦å˜åŒ–
          if (newIndex !== lastIndex) {
            // ç´¢å¼•å˜åŒ–ï¼Œè§¦å‘æŒ¯åŠ¨åé¦ˆ
            this.vibrateFeedback();
            // æ›´æ–°ä¸Šä¸€ä¸ªç´¢å¼•
            lastIndex = newIndex;
          }
          
          this.setData({
            scrollOffset: scrollOffset,
            currentTrackIndex: newIndex
          });
        } else {
          this.setData({
            scrollOffset: scrollOffset
          });
        }
        
        // ç»§ç»­åŠ¨ç”»
        setTimeout(animate, 16);
      } else {
        // é€Ÿåº¦å¤ªå°ï¼Œç»“æŸæƒ¯æ€§æ»šåŠ¨
        this.setData({
          isInertiaScrolling: false
        });
        
        // å¯¹é½åˆ°æœ€è¿‘çš„é€‰é¡¹
        this.snapToClosestItem();
      }
    };
    
    // å¯åŠ¨åŠ¨ç”»
    setTimeout(animate, 16);
  },
  
  /**
   * å¯¹é½åˆ°æœ€è¿‘çš„é€‰é¡¹
   */
  snapToClosestItem: function() {
    const itemCount = this.data.cards.length;
    if (itemCount === 0) return;
    
    // è®¡ç®—æœ€æ¥è¿‘çš„é¡¹ç›®ç´¢å¼•
    const currentOffset = this.data.scrollOffset;
    const cardPositionOffset = this.data.cardPositionOffset || -200; // é»˜è®¤å€¼ä¸º-200rpx
    const rawIndex = Math.round(-(currentOffset - cardPositionOffset) / this.data.itemHeight);
    
    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
    const newIndex = Math.max(0, Math.min(rawIndex, itemCount - 1));
    
    // è®°å½•å½“å‰ç´¢å¼•ç”¨äºæ¯”è¾ƒ
    const oldIndex = this.data.currentTrackIndex;
    
    // è®¡ç®—å¯¹é½åçš„åç§»
    // æ·»åŠ å‘ä¸Šçš„ä½ç½®åç§»ï¼Œä½¿é€‰ä¸­å¡ç‰‡ä½ç½®æ›´é ä¸Š
    const targetOffset = -newIndex * this.data.itemHeight + cardPositionOffset;
    
    // å¦‚æœå½“å‰åç§»ä¸ç›®æ ‡åç§»ç›¸å·®å¤ªå¤§ï¼Œä½¿ç”¨åŠ¨ç”»è¿‡æ¸¡
    if (Math.abs(currentOffset - targetOffset) > 2) {
      this.animateToOffset(targetOffset, newIndex);
    } else {
      // ç›´æ¥è®¾ç½®
      this.setData({
        scrollOffset: targetOffset,
        currentTrackIndex: newIndex
      });
      
      // å¦‚æœç´¢å¼•å˜åŒ–ï¼Œè§¦å‘æŒ¯åŠ¨åé¦ˆ
      if (newIndex !== oldIndex) {
        this.vibrateFeedback();
      }
      
      // è‡ªåŠ¨é€‰ä¸­å½“å‰é¡¹ç›®ï¼ˆä½†ä¸ç«‹å³æ˜¾ç¤ºé¢„è§ˆï¼Œåªè®¾ç½®é€‰ä¸­çŠ¶æ€ï¼‰
      this.setCurrentCardActive();
    }
  },
  
  /**
   * åŠ¨ç”»æ»šåŠ¨åˆ°æŒ‡å®šåç§»
   */
  animateToOffset: function(targetOffset, targetIndex) {
    const startOffset = this.data.scrollOffset;
    const distance = targetOffset - startOffset;
    const duration = 300;
    const startTime = Date.now();
    
    const animate = () => {
      const elapsed = Date.now() - startTime;
      if (elapsed >= duration) {
        // åŠ¨ç”»ç»“æŸ
        this.setData({
          scrollOffset: targetOffset,
          currentTrackIndex: targetIndex,
          isInertiaScrolling: false
        });
        
        // åŠ¨ç”»å®Œæˆåé€‰ä¸­å½“å‰é¡¹ç›®
        this.setCurrentCardActive();
        return;
      }
      
      // ä½¿ç”¨ç¼“åŠ¨æ•ˆæœ
      const progress = this.easeOutQuint(elapsed / duration);
      const currentOffset = startOffset + distance * progress;
      
      this.setData({
        scrollOffset: currentOffset
      });
      
      // ç»§ç»­åŠ¨ç”»
      setTimeout(animate, 16);
    };
    
    // å¯åŠ¨åŠ¨ç”»
    setTimeout(animate, 16);
  },
  
  /**
   * å¹³æ»‘çš„äºŒæ¬¡æ–¹ç¼“åŠ¨å‡½æ•°
   */
  easeOutQuad: function(t) {
    return t * (2 - t);
  },
  
  /**
   * æ›´å¹³æ»‘çš„äº”æ¬¡æ–¹ç¼“åŠ¨å‡½æ•°
   */
  easeOutQuint: function(t) {
    return 1 - Math.pow(1 - t, 5);
  },
  
  /**
   * è®¾ç½®å½“å‰å¡ç‰‡ä¸ºæ¿€æ´»çŠ¶æ€ï¼ˆä¸æ˜¾ç¤ºé¢„è§ˆï¼‰
   */
  setCurrentCardActive: function() {
    if (this.data.cards.length === 0) return;
    
    // è·å–å½“å‰é€‰ä¸­çš„å¡ç‰‡ç´¢å¼•
    const index = this.data.currentTrackIndex;
    
    // åªè®¾ç½®å½“å‰å¡ç‰‡ä¸ºæ¿€æ´»çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºé¢„è§ˆ
    if (index >= 0 && index < this.data.cards.length) {
      // ä»€ä¹ˆéƒ½ä¸åšï¼Œå› ä¸ºactiveçŠ¶æ€æ˜¯é€šè¿‡è§†å›¾å±‚çš„classç»‘å®šè‡ªåŠ¨è®¾ç½®çš„
      console.log('è®¾ç½®å¡ç‰‡æ¿€æ´»çŠ¶æ€:', index);
    }
  },

  /**
   * ç‚¹å‡»æŸ¥çœ‹ä¸»é¢˜è¯¦æƒ… - æ”¹ä¸ºæ˜¾ç¤ºé…å¯¹ç”¨æˆ·
   */
  viewTrackDetail: function(e) {
    const index = e.currentTarget.dataset.index;
    
    // å¦‚æœç‚¹å‡»çš„é¡¹ä¸æ˜¯å½“å‰ä¸­å¿ƒé¡¹ï¼Œå…ˆæ»šåŠ¨åˆ°è¯¥é¡¹
    if (index !== this.data.currentTrackIndex) {
      // ç›´æ¥è®¡ç®—ç›®æ ‡åç§»é‡ï¼Œæ·»åŠ å‘ä¸Šåç§»
      const cardPositionOffset = this.data.cardPositionOffset || -200;
      const targetOffset = -index * this.data.itemHeight + cardPositionOffset;
      
      // ä½¿ç”¨åŠ¨ç”»æ»šåŠ¨ï¼Œç„¶åæ˜¾ç¤ºé…å¯¹ç”¨æˆ·
      this.animateToOffset(targetOffset, index);
      
      // åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºé…å¯¹ç”¨æˆ·
      setTimeout(() => {
        this.showPairedUsers(index);
      }, 300);
    } else {
      // å·²ç»æ˜¯ä¸­å¿ƒé¡¹ï¼Œç›´æ¥æ˜¾ç¤ºé…å¯¹ç”¨æˆ·
      this.showPairedUsers(index);
    }
  },
  
  /**
   * æ˜¾ç¤ºé…å¯¹ç”¨æˆ·
   */
  // ã€é‡å†™ã€‘å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰é…å¯¹ï¼Œæ²¡æœ‰åˆ™AIé…å¯¹
  showPairedUsers: function(index) {
    if (index < 0 || index >= this.data.cards.length) {
      console.error('ä¸»é¢˜ç´¢å¼•æ— æ•ˆ:', index);
      return;
    }

    const theme = this.data.cards[index];
    const classifications = this.data.classifications;
    const currentUserOpenId = this.data.currentUserOpenId;

    console.log('=== æ˜¾ç¤ºä¸»é¢˜é…å¯¹ç”¨æˆ· ===');
    console.log('é€‰ä¸­ä¸»é¢˜:', theme.name);
    console.log('å½“å‰ç”¨æˆ·openid:', currentUserOpenId);

    if (!classifications || !classifications.length) {
      wx.showToast({
        title: 'ç¤¾ç¾¤æ•°æ®æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•',
        icon: 'none'
      });
      return;
    }

    if (!currentUserOpenId) {
      wx.showToast({
        title: 'ç”¨æˆ·ä¿¡æ¯æœªè·å–ï¼Œè¯·ç¨åé‡è¯•',
        icon: 'none'
      });
      return;
    }

    // åœ¨classificationsä¸­æ‰¾åˆ°å¯¹åº”çš„ä¸»é¢˜æ•°æ®
    const themeData = classifications.find(t => t.theme === theme.name);
    if (!themeData || !themeData.communities) {
      console.log('æœªæ‰¾åˆ°ä¸»é¢˜æ•°æ®æˆ–ç¤¾ç¾¤æ•°æ®:', theme.name);
      wx.showToast({
        title: `${theme.name}æš‚æ— ç¤¾ç¾¤æ•°æ®`,
        icon: 'none'
      });
      return;
    }

    // æŸ¥æ‰¾å½“å‰ç”¨æˆ·æ‰€åœ¨çš„ç¤¾ç¾¤
    let userCommunity = null;
    let communityMembers = [];

    for (const community of themeData.communities) {
      if (community.members) {
        const userInCommunity = community.members.find(member => member.openid === currentUserOpenId);
        if (userInCommunity) {
          userCommunity = community;
          // è·å–é™¤å½“å‰ç”¨æˆ·å¤–çš„å…¶ä»–æˆå‘˜
          communityMembers = community.members.filter(member => member.openid !== currentUserOpenId);
          console.log('æ‰¾åˆ°ç”¨æˆ·ç¤¾ç¾¤:', community.name, 'å…¶ä»–æˆå‘˜æ•°é‡:', communityMembers.length);
          break;
        }
      }
    }

    if (!userCommunity) {
      wx.showToast({
        title: `æ‚¨åœ¨${theme.name}ä¸»é¢˜ä¸‹è¿˜æœªè¢«åˆ†é…åˆ°ç¤¾ç¾¤`,
        icon: 'none',
        duration: 3000
      });
      return;
    }

    if (communityMembers.length === 0) {
      wx.showToast({
        title: `æ‚¨çš„ç¤¾ç¾¤"${userCommunity.name}"ä¸­æš‚æ— å…¶ä»–æˆå‘˜`,
        icon: 'none',
        duration: 3000
      });
      return;
    }

    // å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰é…å¯¹
    this.checkExistingPairs(theme, userCommunity, communityMembers);
  },

  /**
   * æ£€æŸ¥æ˜¯å¦å·²æœ‰é…å¯¹
   */
  checkExistingPairs: function(theme, userCommunity, communityMembers) {
    const currentUserOpenId = this.data.currentUserOpenId;
    
    console.log('=== æ£€æŸ¥ç°æœ‰é…å¯¹ ===');
    console.log('ä¸»é¢˜:', theme.name);
    console.log('ç¤¾ç¾¤:', userCommunity.name);
    
    wx.showLoading({
      title: 'æ£€æŸ¥é…å¯¹ä¿¡æ¯...',
    });

    // æŸ¥è¯¢connectionsé›†åˆ
    const db = wx.cloud.database();
    db.collection('connections')
      .where({
        theme: theme.name,
        community: userCommunity.name
      })
      .get({
        success: (res) => {
          wx.hideLoading();
          console.log('connectionsæŸ¥è¯¢ç»“æœ:', res.data);
          
          if (res.data && res.data.length > 0) {
            // æŸ¥æ‰¾åŒ…å«å½“å‰ç”¨æˆ·çš„é…å¯¹ç»„
            const userPairGroup = res.data.find(group => 
              group.pairedUsers && group.pairedUsers.includes(currentUserOpenId)
            );
            
            if (userPairGroup) {
              console.log('æ‰¾åˆ°ç°æœ‰é…å¯¹ç»„:', userPairGroup);
              
              // è·å–é…å¯¹ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
              const pairedUserIds = userPairGroup.pairedUsers.filter(id => id !== currentUserOpenId);
              const pairedUsers = communityMembers.filter(member => 
                pairedUserIds.includes(member.openid)
              );
              
              console.log('é…å¯¹çš„ç”¨æˆ·:', pairedUsers);
              
              // æ˜¾ç¤ºé…å¯¹ç”¨æˆ·
              this.showPairedUsersPreview(theme, userCommunity, pairedUsers, 'å·²é…å¯¹');
              return;
            }
          }
          
          // æ²¡æœ‰æ‰¾åˆ°é…å¯¹ï¼Œå¼€å§‹AIé…å¯¹
          console.log('æœªæ‰¾åˆ°ç°æœ‰é…å¯¹ï¼Œå¼€å§‹AIé…å¯¹');
          this.requestAIPairing(theme, userCommunity, communityMembers);
        },
        fail: (err) => {
          wx.hideLoading();
          console.error('æŸ¥è¯¢connectionså¤±è´¥:', err);
          
          // æŸ¥è¯¢å¤±è´¥ï¼Œä»ç„¶å°è¯•AIé…å¯¹
          console.log('æŸ¥è¯¢å¤±è´¥ï¼Œç»§ç»­è¿›è¡ŒAIé…å¯¹');
          this.requestAIPairing(theme, userCommunity, communityMembers);
        }
      });
  },

  /**
   * è¯·æ±‚AIé…å¯¹
   */
  requestAIPairing: async function(theme, userCommunity, communityMembers) {
    const currentUserOpenId = this.data.currentUserOpenId;
    
    console.log('=== å¼€å§‹AIé…å¯¹ ===');
    console.log('ç¤¾ç¾¤æˆå‘˜æ•°é‡:', communityMembers.length);
    
    if (communityMembers.length === 0) {
      wx.showToast({
        title: 'ç¤¾ç¾¤ä¸­æš‚æ— å…¶ä»–æˆå‘˜å¯é…å¯¹',
        icon: 'none'
      });
      return;
    }

    wx.showLoading({
      title: 'AIæ™ºèƒ½é…å¯¹ä¸­...',
    });

    try {
      // åˆå§‹åŒ–äº‘å¼€å‘AI
      wx.cloud.init({
        env: "unionlink-4gkmzbm1babe86a7"
      });

      // æ„å»ºAIæç¤ºè¯
      const membersInfo = communityMembers.map(member => {
        const userInfo = member.userInfo || {};
        const responses = member.responses || {};
        
        return {
          openid: member.openid,
          æ˜µç§°: userInfo.nickName || 'æœªè®¾ç½®',
          é—®å·å›ç­”: responses
        };
      }).slice(0, 10); // é™åˆ¶æœ€å¤š10ä¸ªæˆå‘˜ï¼Œé¿å…promptè¿‡é•¿

      const prompt = `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ç¤¾äº¤é…å¯¹ä¸“å®¶ã€‚è¯·ä¸ºç”¨æˆ·åœ¨"${theme.name}"ä¸»é¢˜ä¸‹çš„"${userCommunity.name}"ç¤¾ç¾¤ä¸­æ‰¾åˆ°1-2ä½æœ€é€‚åˆçš„é…å¯¹ä¼™ä¼´ã€‚

ç¤¾ç¾¤æè¿°ï¼š${userCommunity.description || 'æ— '}

ç¤¾ç¾¤æˆå‘˜ä¿¡æ¯ï¼š
${JSON.stringify(membersInfo, null, 2)}

è¯·æ ¹æ®æˆå‘˜çš„é—®å·å›ç­”ã€å…´è¶£çˆ±å¥½ç­‰ä¿¡æ¯ï¼Œåˆ†æä»–ä»¬çš„å…¼å®¹æ€§å’Œäº’è¡¥æ€§ï¼Œé€‰æ‹©1-2ä½æœ€é€‚åˆé…å¯¹çš„æˆå‘˜ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
{
  "pairedUsers": ["openid1", "openid2"],
  "reason": "é…å¯¹ç†ç”±ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¿™äº›ç”¨æˆ·é€‚åˆé…å¯¹"
}`;

      console.log('AIæç¤ºè¯:', prompt);

      // åˆ›å»ºæ¨¡å‹å¹¶è°ƒç”¨
      const model = wx.cloud.extend.AI.createModel("deepseek");
      const res = await model.generateText({
        model: "deepseek-v3-function-call",
        messages: [{ role: "user", content: prompt }],
      });

      console.log('AIè¿”å›åŸå§‹ç»“æœ:', res);

      // è§£æAIè¿”å›ç»“æœ
      let aiResult;
      try {
        // è·å–AIè¿”å›çš„å†…å®¹
        const aiContent = res.choices[0].message.content;
        console.log('AIè¿”å›å†…å®¹:', aiContent);
        
        // å°è¯•è§£æJSON
        aiResult = JSON.parse(aiContent);
        console.log('è§£æåçš„AIç»“æœ:', aiResult);
      } catch (parseError) {
        console.error('è§£æAIè¿”å›ç»“æœå¤±è´¥:', parseError);
        throw new Error('AIè¿”å›ç»“æœæ ¼å¼å¼‚å¸¸');
      }

      if (!aiResult.pairedUsers || !Array.isArray(aiResult.pairedUsers)) {
        throw new Error('AIè¿”å›çš„é…å¯¹ç”¨æˆ·æ ¼å¼å¼‚å¸¸');
      }

      // éªŒè¯é…å¯¹ç”¨æˆ·æ˜¯å¦å­˜åœ¨
      const validPairedUsers = aiResult.pairedUsers.filter(openid => 
        communityMembers.some(member => member.openid === openid)
      );

      if (validPairedUsers.length === 0) {
        throw new Error('AIè¿”å›çš„é…å¯¹ç”¨æˆ·æ— æ•ˆ');
      }

      console.log('æœ‰æ•ˆçš„é…å¯¹ç”¨æˆ·:', validPairedUsers);

      // ä¿å­˜é…å¯¹ç»“æœåˆ°äº‘ç«¯
      await this.saveConnectionToCloud(theme, userCommunity, [currentUserOpenId, ...validPairedUsers], aiResult.reason);

      // è·å–é…å¯¹ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
      const pairedUsers = communityMembers.filter(member => 
        validPairedUsers.includes(member.openid)
      );

      wx.hideLoading();

      // æ˜¾ç¤ºé…å¯¹ç»“æœ
      this.showPairedUsersPreview(theme, userCommunity, pairedUsers, 'AIé…å¯¹', aiResult.reason);

    } catch (error) {
      wx.hideLoading();
      console.error('AIé…å¯¹å¤±è´¥:', error);
      
      wx.showModal({
        title: 'é…å¯¹å¤±è´¥',
        content: `AIé…å¯¹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}ã€‚æ˜¯å¦æ˜¾ç¤ºç¤¾ç¾¤æ‰€æœ‰æˆå‘˜ï¼Ÿ`,
        showCancel: true,
        confirmText: 'æ˜¾ç¤ºæ‰€æœ‰æˆå‘˜',
        cancelText: 'ç¨åé‡è¯•',
        success: (res) => {
          if (res.confirm) {
            // æ˜¾ç¤ºæ‰€æœ‰ç¤¾ç¾¤æˆå‘˜
            this.showPairedUsersPreview(theme, userCommunity, communityMembers, 'ç¤¾ç¾¤æˆå‘˜');
          }
        }
      });
    }
  },

  /**
   * ä¿å­˜é…å¯¹ç»“æœåˆ°äº‘ç«¯
   */
  saveConnectionToCloud: function(theme, userCommunity, pairedUsers, reason) {
    return new Promise((resolve, reject) => {
      console.log('=== ä¿å­˜é…å¯¹ç»“æœåˆ°äº‘ç«¯ ===');
      console.log('ä¸»é¢˜:', theme.name);
      console.log('ç¤¾ç¾¤:', userCommunity.name);
      console.log('é…å¯¹ç”¨æˆ·:', pairedUsers);
      console.log('é…å¯¹ç†ç”±:', reason);

      const db = wx.cloud.database();
      
      // ä¿å­˜é…å¯¹ç»“æœ
      db.collection('connections').add({
        data: {
          theme: theme.name,
          community: userCommunity.name,
          pairedUsers: pairedUsers,
          reason: reason,
          createTime: new Date(),
          updateTime: new Date()
        },
        success: (res) => {
          console.log('é…å¯¹ç»“æœä¿å­˜æˆåŠŸ:', res._id);
          resolve(res);
        },
        fail: (err) => {
          console.error('é…å¯¹ç»“æœä¿å­˜å¤±è´¥:', err);
          reject(err);
        }
      });
    });
  },

  /**
   * æ˜¾ç¤ºé…å¯¹ç”¨æˆ·é¢„è§ˆ
   */
  showPairedUsersPreview: function(theme, userCommunity, pairedUsers, pairType, reason) {
    console.log('=== æ˜¾ç¤ºé…å¯¹ç”¨æˆ·é¢„è§ˆ ===');
    console.log('é…å¯¹ç±»å‹:', pairType);
    console.log('é…å¯¹ç”¨æˆ·æ•°é‡:', pairedUsers.length);
    console.log('é…å¯¹ç†ç”±:', reason);

    // æ˜¾ç¤ºé…å¯¹ç”¨æˆ·é¢„è§ˆ
    this.setData({
      showCardPreview: true,
      selectedCard: {
        ...theme,
        pairedUsers: pairedUsers,
        communityName: userCommunity.name,
        communityDescription: userCommunity.description,
        totalMembers: userCommunity.members.length,
        otherMembersCount: pairedUsers.length,
        pairType: pairType,
        pairReason: reason
      }
    });

    console.log('æ˜¾ç¤ºé…å¯¹é¢„è§ˆ:', {
      ä¸»é¢˜: theme.name,
      ç¤¾ç¾¤: userCommunity.name,
      é…å¯¹ç±»å‹: pairType,
      é…å¯¹ç”¨æˆ·æ•°: pairedUsers.length
    });
  },

  /**
   * æŸ¥çœ‹ç”¨æˆ·åç‰‡
   */
  viewUserProfile: function(e) {
    const openid = e.currentTarget.dataset.openid;
    const user = this.data.communityMembers.find(u => u.openid === openid);
    if (user) {
      wx.navigateTo({
        url: `/pages/userProfile/userProfile?openid=${openid}`
      });
    }
  },

  /**
   * æ˜¾ç¤ºä¸»é¢˜è¯¦æƒ…
   */
  showCardDetail: function(index) {
    if (index >= 0 && index < this.data.cards.length) {
      const card = this.data.cards[index];
      this.setData({
        selectedCard: card,
        showCardPreview: true
      });
    }
  },
  
  /**
   * å…³é—­ä¸»é¢˜é¢„è§ˆ
   */
  closeCardPreview: function() {
    this.setData({
      showCardPreview: false
    });
  },

  /**
   * åˆå§‹åŒ–ä¸»é¢˜å¡ç‰‡æ•°æ®
   */
  initThemeCards: function() {
    const themeCards = [
      {
        id: 1,
        name: "æ•°ç è½¨è¿¹åšç‰©é¦†",
        subtitle: "Digital Trace Museum",
        description: "æ•°ç æˆé•¿å² Ã— æƒ…æ€€ Ã— æ•°å­—äººæ ¼è¿›åŒ–",
        theme: "æ•°ç è½¨è¿¹åšç‰©é¦†",
        color: "#6366f1",
        avatarUrl: "https://api.dicebear.com/7.x/shapes/svg?seed=digital&backgroundColor=6366f1",
        details: {
          concept: "æ•°ç æˆé•¿å² Ã— æƒ…æ€€ Ã— æ•°å­—äººæ ¼è¿›åŒ–",
          features: ["ğŸ§‘â€ğŸš€ åŸå§‹ä¿¡å·å®ˆæœ›è€…", "ğŸ•¹ï¸ æŒä¸Šæ–‡æ˜ç¼”é€ è€…", "ğŸŒ äº‘ç«¯åŸå±…æ°‘", "ğŸ§­ è®¾å¤‡æç®€ä¸»ä¹‰è€…"],
          philosophy: "æ¯ä¸€ä»£è®¾å¤‡ï¼Œéƒ½æ˜¯ä¸€æ®µäººç”Ÿçš„ç¼©å½±ã€‚"
        }
      },
      {
        id: 2,
        name: "æ„Ÿå®˜æ²‰æµ¸ç ”ç©¶æ‰€",
        subtitle: "Sensory Immersion Lab",
        description: "æ„Ÿå®˜åå¥½ Ã— æ²‰æµ¸ Ã— ä½“éªŒé£æ ¼",
        theme: "æ„Ÿå®˜æ²‰æµ¸ç ”ç©¶æ‰€",
        color: "#ec4899",
        avatarUrl: "https://api.dicebear.com/7.x/shapes/svg?seed=sensory&backgroundColor=ec4899",
        details: {
          concept: "æ„Ÿå®˜åå¥½ Ã— æ²‰æµ¸ Ã— ä½“éªŒé£æ ¼",
          features: ["ğŸ¨ è§†è§‰ä¸»ä¹‰è€…", "ğŸ§ å£°æ³¢æ„Ÿåº”è€…", "ğŸ¤² è§¦è§‰æŒæ§è€…", "ğŸ§  æ€ç»´æ²‰æµ¸è€…"],
          philosophy: "æ²‰æµ¸äºæ„Ÿå®˜ï¼Œä½“éªŒäºå¿ƒçµã€‚"
        }
      },
      {
        id: 3,
        name: "è¡Œä¸ºæ–¹å¼åŒ¹é…ç«™",
        subtitle: "Behavior Match Station",
        description: "æ¢ç´¢é£æ ¼ Ã— å¥½å¥‡å¿ƒ Ã— å±•ä¼šè¡ŒåŠ¨è½¨è¿¹",
        theme: "è¡Œä¸ºæ–¹å¼åŒ¹é…ç«™",
        color: "#10b981",
        avatarUrl: "https://api.dicebear.com/7.x/shapes/svg?seed=behavior&backgroundColor=10b981",
        details: {
          concept: "æ¢ç´¢é£æ ¼ Ã— å¥½å¥‡å¿ƒ Ã— å±•ä¼šè¡ŒåŠ¨è½¨è¿¹",
          features: ["ğŸš€ å¿«é€Ÿå°é²œç©å®¶", "ğŸ‘“ ä¿¡æ¯è§‚å¯Ÿè€…", "ğŸ“· å†…å®¹åˆ›ä½œè€…", "ğŸ›¸ å®‰é™æ¢ç´¢è€…"],
          philosophy: "æ¯ä¸€ç§è¡Œä¸ºï¼Œéƒ½æ˜¯ç‹¬ç‰¹çš„æ¢ç´¢ã€‚"
        }
      },
      {
        id: 4,
        name: "èƒ½é‡èŠ‚å¾‹æ˜Ÿçƒ",
        subtitle: "Energy Rhythm Planet",
        description: "ä½œæ¯åå¥½ Ã— æ˜Ÿåº§ Ã— MBTI Ã— çŠ¶æ€æ˜ å°„",
        theme: "èƒ½é‡èŠ‚å¾‹æ˜Ÿçƒ",
        color: "#f59e0b",
        avatarUrl: "https://api.dicebear.com/7.x/shapes/svg?seed=energy&backgroundColor=f59e0b",
        details: {
          concept: "ä½œæ¯åå¥½ Ã— æ˜Ÿåº§ Ã— MBTI Ã— çŠ¶æ€æ˜ å°„",
          features: ["ğŸŒ æ™¨å…‰è§„åˆ’è€…", "â˜€ï¸ åˆé—´èšèƒ½äºº", "ğŸŒŒ å¤œé—´çµæ„Ÿæ—", "ğŸŒ«ï¸ éšå¢ƒæ³¢åŠ¨è€…"],
          philosophy: "èŠ‚å¾‹ä¸åŒï¼Œèƒ½é‡å„å¼‚ã€‚"
        }
      }
    ];

    this.setData({
      cards: themeCards,
      isLoading: false
    });
  },

  /**
   * è·å–äº¤äº’ç”¨æˆ·åç‰‡ - æ”¹ä¸ºè·å–ä¸»é¢˜æ•°æ®
   */
  getInteractionCards: function() {
    // ç›´æ¥è°ƒç”¨åˆå§‹åŒ–ä¸»é¢˜å¡ç‰‡
    this.initThemeCards();
  },

  /**
   * å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
   */
  onImageError: function(e) {
    const index = e.currentTarget.dataset.index;
    console.error(`ä¸»é¢˜å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç´¢å¼•: ${index}`, e);
    
    // è·å–å½“å‰ä¸»é¢˜å¡ç‰‡
    const card = this.data.cards[index];
    if (card) {
      console.log('åŠ è½½å¤±è´¥çš„å›¾ç‰‡URL:', card.avatarUrl);
      
      // å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®å¤‡ç”¨å›¾ç‰‡æˆ–æ¸…ç©ºURL
      // ç®€å•å°†è¯¥å¡ç‰‡çš„å¤´åƒURLè®¾ä¸ºç©º
      const newCards = [...this.data.cards];
      newCards[index].avatarUrl = '';
      
      this.setData({
        cards: newCards
      });
    }
  },
  
  /**
   * å›¾ç‰‡åŠ è½½æˆåŠŸå¤„ç†
   */
  onImageLoad: function(e) {
    const index = e.currentTarget.dataset.index;
    console.log(`ä¸»é¢˜å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œç´¢å¼•: ${index}`);
  },

  /**
   * è®¾ç½®è§¦æ‘¸æ€§èƒ½ä¼˜åŒ–é€‰é¡¹
   */
  setTouchPerfOptions: function() {
    // è®¾ç½®wx.createSelectorQueryçš„æ€§èƒ½é€‰é¡¹
    if (wx.canIUse('createSelectorQuery.in')) {
      const query = wx.createSelectorQuery();
      
      // å°è¯•ç¦ç”¨æ»šåŠ¨èŠ‚æµï¼Œæé«˜æµç•…åº¦
      if (query.in && query.in.scrollThrottle) {
        query.in({
          scrollThrottle: false
        });
      }
    }
    
    // è®¾ç½®é¡µé¢æ¸²æŸ“å±‚ä¼˜åŒ–
    if (wx.canIUse('setPageStyle')) {
      wx.setPageStyle({
        style: {
          // å¼€å¯æ¸²æŸ“æ–°å±‚ä¼˜åŒ–
          'layer-performance-mode': 'fast'
        }
      }).catch(() => {
        // å¿½ç•¥ä¸æ”¯æŒçš„APIé”™è¯¯
      });
    }
  },

  /**
   * ç”ŸæˆèƒŒæ™¯æ˜Ÿæ˜Ÿ
   */
  generateStars() {
    const starCount = 50; // æ˜Ÿæ˜Ÿæ•°é‡
    let stars = [];
    
    for (let i = 0; i < starCount; i++) {
      // éšæœºä½ç½®å’Œå¤§å°
      stars.push({
        id: i,
        x: Math.random() * 750, // å±å¹•å®½åº¦ä¸º750rpx
        y: Math.random() * 1600, // å‡è®¾å±å¹•é«˜åº¦
        size: Math.random() * 4 + 1, // æ˜Ÿæ˜Ÿå¤§å°1-5rpx
        opacity: Math.random() * 0.5 + 0.1, // ä¸é€æ˜åº¦0.1-0.6
      });
    }
    
    this.setData({ stars });
  },

  /**
   * åˆå§‹åŒ–åŠ¨ç”»
   */
  initAnimation() {
    // å¯åŠ¨å”±ç‰‡æ—‹è½¬
    this.startDiscRotation();
    
    // è®¾ç½®è§¦æ‘¸æ€§èƒ½ä¼˜åŒ–ï¼Œæé«˜æ»šåŠ¨æµç•…åº¦
    this.setTouchPerfOptions();
    
    // åˆå§‹åŒ–ä¸»é¢˜é¢„è§ˆç›¸å…³æ•°æ®
    this.setData({
      showCardPreview: false,
      selectedCard: {}
    });
  },

  /**
   * åŒæ­¥ä¸»é¢˜ç´¢å¼•åˆ°å…¨å±€æ•°æ®
   */
  syncThemeToGlobal: function(themeIndex) {
    const app = getApp();
    if (!app.globalData) {
      app.globalData = {};
    }
    app.globalData.currentThemeIndex = themeIndex;
    
    // ä¸»é¢˜åˆ‡æ¢æ—¶é‡æ–°åŠ è½½ç¤¾ç¾¤æˆå‘˜
    this.loadCommunityMembers();
    
    console.log(`åŒæ­¥ä¸»é¢˜ç´¢å¼•åˆ°å…¨å±€: ${themeIndex}`);
  },

  // ã€å®Œå…¨ç…§æŠ„briefingé¡µé¢ã€‘è°ƒç”¨äº‘å‡½æ•°è¿›è¡Œç”¨æˆ·åˆ†ç±»
  classifyUsers: function() {
    console.log('[ConnectPage] å¼€å§‹åˆ†æç¤¾ç¾¤...');
    wx.showLoading({
      title: 'æ­£åœ¨åˆ†æç¤¾ç¾¤...',
    });

    // è°ƒç”¨äº‘å‡½æ•°è¿›è¡Œåˆ†ç±»
    wx.cloud.callFunction({
      name: 'classifyUsers',
      data: {},
      success: res => {
        console.log('[classifyUsers] success:', res.result);
        // åˆ†ç±»æˆåŠŸåï¼Œä» class_bar è¯»å–åˆ†ç±»ç»“æœ
        const db = wx.cloud.database();
        db.collection('class_bar').get({
          success: res => {
            console.log('ä»class_barè·å–æ•°æ®æˆåŠŸ', res.data);
            console.log('class_baråŸå§‹æ•°æ®ç»“æ„æ£€æŸ¥:', res.data);
            
            // æ ¹æ®READMEæ–‡æ¡£ï¼Œæ•°æ®ç»“æ„åº”è¯¥æ˜¯ res.data[0].data
            let classifications = [];
            if (res.data && res.data.length > 0 && res.data[0].data) {
              classifications = res.data[0].data;
              console.log('è§£æå‡ºçš„ä¸»é¢˜æ•°ç»„:', classifications);
            } else {
              console.error('class_baræ•°æ®ç»“æ„ä¸ç¬¦åˆé¢„æœŸ');
              classifications = res.data; // é™çº§å¤„ç†
            }

            // è·å–å½“å‰ç”¨æˆ·openidå¹¶é‡æ’åº
            wx.cloud.callFunction({
              name: 'login',
              success: loginRes => {
                const openid = loginRes.result.openid;
                const reorderedClassifications = classifications.map(theme => {
                  theme.communities.forEach(community => {
                    const userIndex = community.members.findIndex(member => member.openid === openid);
                    if (userIndex > 0) {
                      const user = community.members.splice(userIndex, 1)[0];
                      community.members.unshift(user);
                    }
                    // åˆ›å»ºä¸€ä¸ªåªåŒ…å«å‰3ä¸ªæˆå‘˜çš„æ•°ç»„ç”¨äºæ˜¾ç¤º
                    community.displayMembers = community.members.slice(0, 3);
                  });
                  return theme;
                });

                this.setData({
                  classifications: reorderedClassifications,
                  currentUserOpenId: openid
                });
                wx.hideLoading();
                
                console.log('[ConnectPage] ç¤¾ç¾¤åˆ†æå®Œæˆï¼Œæ•°æ®å·²åŠ è½½');
                // æˆåŠŸååŠ è½½ç¤¾ç¾¤æˆå‘˜æ•°æ®
                this.loadCommunityMembers();
              },
              fail: loginErr => {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', loginErr);
                this.setData({ 
                  classifications,
                  currentUserOpenId: '' // å¤±è´¥æ—¶æ¸…ç©º
                });
                wx.hideLoading();
              }
            });
          },
          fail: err => {
            console.error('ä»class_barè·å–æ•°æ®å¤±è´¥', err);
            wx.hideLoading();
            wx.showToast({
              title: 'è·å–ç¤¾ç¾¤æ•°æ®å¤±è´¥',
              icon: 'none'
            });
          }
        });
      },
      fail: err => {
        console.error('[classifyUsers] fail:', err);
        wx.hideLoading();
        wx.showToast({
          title: 'ç¤¾ç¾¤åˆ†æå¤±è´¥',
          icon: 'none'
        });
      }
    });
  },

  /**
   * è·å–å½“å‰ä¸»é¢˜ä¸‹å°åˆ†ç±»çš„æ‰€æœ‰ç”¨æˆ·å¹¶AIé…å¯¹ - æ”¹ä¸ºç›´æ¥ä½¿ç”¨åˆ†ç±»æ•°æ®
   */
  getThemeUsersAndPair: async function() {
    // ç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¤¾ç¾¤æˆå‘˜æ•°æ®ï¼Œä¸å†é‡æ–°AIé…å¯¹
    this.loadCommunityMembers();
  },

  /**
   * è·å–å½“å‰ç”¨æˆ·openid
   */
  getCurrentUserOpenid: function() {
    // å…ˆå°è¯•ä»ç¼“å­˜è·å–
    let openid = wx.getStorageSync('openid');
    console.log('ä»ç¼“å­˜è·å–çš„openid:', openid);
    
    if (openid) {
      this.setData({
        currentUserOpenid: openid
      });
      console.log('æˆåŠŸè®¾ç½®ç”¨æˆ·openid:', openid);
      return;
    }
    
    // å¦‚æœç¼“å­˜æ²¡æœ‰ï¼Œè°ƒç”¨loginäº‘å‡½æ•°è·å–
    console.log('ç¼“å­˜ä¸­æ— openidï¼Œè°ƒç”¨loginäº‘å‡½æ•°...');
    wx.cloud.callFunction({
      name: 'login',
      success: (res) => {
        console.log('loginäº‘å‡½æ•°è¿”å›ç»“æœ:', res);
        if (res.result && res.result.openid) {
          openid = res.result.openid;
          this.setData({
            currentUserOpenid: openid
          });
          // ç¼“å­˜openid
          wx.setStorageSync('openid', openid);
          console.log('æˆåŠŸè·å–å¹¶ç¼“å­˜openid:', openid);
          
          // é‡æ–°åŠ è½½ç¤¾ç¾¤æˆå‘˜æ•°æ®
          this.loadCommunityMembers();
        } else {
          console.error('loginäº‘å‡½æ•°è¿”å›æ•°æ®å¼‚å¸¸:', res.result);
          wx.showToast({
            title: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
            icon: 'none'
          });
        }
      },
      fail: (err) => {
        console.error('è·å–ç”¨æˆ·openidå¤±è´¥:', err);
        wx.showToast({
          title: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•',
          icon: 'none'
        });
      }
    });
  },

  /**
   * åŠ è½½åˆ†ç±»æ•°æ®
   */
  loadClassificationData: function() {
    const db = wx.cloud.database();
    
    console.log('å¼€å§‹åŠ è½½åˆ†ç±»æ•°æ®...');
    // æ˜¾ç¤ºåŠ è½½æç¤º
    wx.showLoading({
      title: 'åŠ è½½ç¤¾ç¾¤æ•°æ®...',
      mask: true
    });
    
    // ä»class_baré›†åˆè·å–åˆ†ç±»æ•°æ®
    db.collection('class_bar').get({
      success: (res) => {
        wx.hideLoading();
        console.log('class_baræ•°æ®åº“æŸ¥è¯¢ç»“æœ:', res);
        
        if (res.data && res.data.length > 0) {
          // è·å–ç¬¬ä¸€æ¡è®°å½•çš„dataå­—æ®µ
          const classificationData = res.data[0].data || [];
          console.log('è§£æå‡ºçš„åˆ†ç±»æ•°æ®:', classificationData);
          
          this.setData({
            classificationData: classificationData
          });
          
          console.log('åˆ†ç±»æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', classificationData.length, 'ä¸ªä¸»é¢˜');
          
          // åŠ è½½å½“å‰ä¸»é¢˜çš„ç¤¾ç¾¤æˆå‘˜
          this.loadCommunityMembers();
        } else {
          console.log('class_baré›†åˆä¸ºç©ºæˆ–æ— æ•°æ®');
          wx.showToast({
            title: 'æš‚æ— ç¤¾ç¾¤æ•°æ®ï¼Œè¯·å…ˆå®Œæˆåˆ†ç±»',
            icon: 'none',
            duration: 3000
          });
        }
      },
      fail: (err) => {
        wx.hideLoading();
        console.error('åŠ è½½åˆ†ç±»æ•°æ®å¤±è´¥:', err);
        wx.showToast({
          title: 'æ•°æ®åº“è¿æ¥å¤±è´¥',
          icon: 'none',
          duration: 3000
        });
      }
    });
  },

  /**
   * ã€ç…§æŠ„briefingæˆåŠŸæ–¹æ¡ˆã€‘æ ¹æ®å½“å‰ä¸»é¢˜åŠ è½½ç¤¾ç¾¤æˆå‘˜
   */
  loadCommunityMembers: function() {
    const currentThemeIndex = this.data.currentTrackIndex;
    const currentTheme = this.data.cards[currentThemeIndex];
    const classifications = this.data.classifications; // ä½¿ç”¨æ–°çš„æ•°æ®ç»“æ„
    const currentUserOpenid = this.data.currentUserOpenId; // ä½¿ç”¨æ–°çš„å­—æ®µå
    
    console.log('=== ã€æ–°ç‰ˆæœ¬ã€‘å¼€å§‹åŠ è½½ç¤¾ç¾¤æˆå‘˜ ===');
    console.log('å½“å‰ä¸»é¢˜ç´¢å¼•:', currentThemeIndex);
    console.log('å½“å‰ä¸»é¢˜:', currentTheme);
    console.log('åˆ†ç±»æ•°æ®é•¿åº¦:', classifications.length);
    console.log('å½“å‰ç”¨æˆ·openid:', currentUserOpenid);
    
    if (!currentTheme) {
      console.error('å½“å‰ä¸»é¢˜ä¸ºç©º');
      return;
    }
    
    if (!classifications.length) {
      console.error('åˆ†ç±»æ•°æ®ä¸ºç©º');
      wx.showToast({
        title: 'è¯·ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ',
        icon: 'none'
      });
      return;
    }
    
    if (!currentUserOpenid) {
      console.error('ç”¨æˆ·openidä¸ºç©º');
      wx.showToast({
        title: 'è¯·ç¨åé‡è¯•',
        icon: 'none'
      });
      return;
    }
    
               // ã€è°ƒè¯•ã€‘å…ˆæŸ¥çœ‹å®é™…çš„æ•°æ®ç»“æ„
      console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
      console.log('classificationsåŸå§‹æ•°æ®:', classifications);
      console.log('classificationsé•¿åº¦:', classifications.length);
      if (classifications.length > 0) {
        console.log('classifications[0]ç»“æ„:', classifications[0]);
        console.log('classifications[0]çš„keys:', Object.keys(classifications[0]));
      }
      
      // ã€ä¿®æ­£ã€‘classificationsæ•°ç»„æ¯ä¸ªå…ƒç´ ç›´æ¥å°±æ˜¯ä¸»é¢˜å¯¹è±¡
      if (!classifications.length) {
        console.error('classificationsæ•°æ®ä¸ºç©º');
        wx.showToast({
          title: 'æš‚æ— åˆ†ç±»æ•°æ®',
          icon: 'none'
        });
        return;
      }
      
      console.log('å¯ç”¨ä¸»é¢˜åˆ—è¡¨:', classifications.map(t => t.theme));
      console.log('å½“å‰é€‰æ‹©çš„ä¸»é¢˜å:', currentTheme.name);
      
      // ç›´æ¥åœ¨classificationsæ•°ç»„ä¸­åŒ¹é…ä¸»é¢˜åç§°
      const themeData = classifications.find(theme => theme.theme === currentTheme.name);
    console.log('æ‰¾åˆ°çš„ä¸»é¢˜æ•°æ®:', themeData);
    
          if (!themeData || !themeData.communities) {
        console.log('æœªæ‰¾åˆ°å½“å‰ä¸»é¢˜çš„ç¤¾ç¾¤æ•°æ®:', currentTheme.name);
        console.log('å¯ç”¨çš„ä¸»é¢˜åˆ—è¡¨:', classifications.map(t => t.theme));
      this.setData({
        communityMembers: [],
        currentUserCommunity: null
      });
      wx.showToast({
        title: 'è¯¥ä¸»é¢˜æš‚æ— ç¤¾ç¾¤æ•°æ®',
        icon: 'none'
      });
      return;
    }
    
    console.log('ä¸»é¢˜ç¤¾ç¾¤æ•°é‡:', themeData.communities.length);
    
    // æŸ¥æ‰¾å½“å‰ç”¨æˆ·æ‰€åœ¨çš„ç¤¾ç¾¤
    let userCommunity = null;
    let communityMembers = [];
    
    for (let i = 0; i < themeData.communities.length; i++) {
      const community = themeData.communities[i];
      console.log(`æ£€æŸ¥ç¤¾ç¾¤ ${i + 1}:`, community.name, 'æˆå‘˜æ•°é‡:', community.members ? community.members.length : 0);
      
      if (community.members) {
        const userInCommunity = community.members.find(member => {
          console.log('æ£€æŸ¥æˆå‘˜openid:', member.openid, 'ä¸å½“å‰ç”¨æˆ·:', currentUserOpenid);
          return member.openid === currentUserOpenid;
        });
        
        if (userInCommunity) {
          console.log('æ‰¾åˆ°ç”¨æˆ·æ‰€åœ¨ç¤¾ç¾¤:', community.name);
          userCommunity = community;
          // è·å–é™¤äº†å½“å‰ç”¨æˆ·ä¹‹å¤–çš„å…¶ä»–æˆå‘˜
          communityMembers = community.members.filter(member => 
            member.openid !== currentUserOpenid
          );
          console.log('ç¤¾ç¾¤å…¶ä»–æˆå‘˜æ•°é‡:', communityMembers.length);
          break;
        }
      }
    }
    
    console.log('å½“å‰ç”¨æˆ·ç¤¾ç¾¤:', userCommunity);
    console.log('ç¤¾ç¾¤å…¶ä»–æˆå‘˜:', communityMembers);
    
    this.setData({
      currentUserCommunity: userCommunity,
      communityMembers: communityMembers,
      myPairs: communityMembers // å¤ç”¨åŸæœ‰çš„æ˜¾ç¤ºé€»è¾‘
    });
    
    if (!userCommunity) {
      wx.showToast({
        title: 'æ‚¨è¿˜æœªè¢«åˆ†é…åˆ°ä»»ä½•ç¤¾ç¾¤',
        icon: 'none',
        duration: 3000
      });
    } else {
      console.log('æˆåŠŸåŠ è½½ç¤¾ç¾¤æˆå‘˜ï¼Œç¤¾ç¾¤:', userCommunity.name, 'å…¶ä»–æˆå‘˜:', communityMembers.length);
    }
  },

  /**
   * æ˜¾ç¤ºé…å¯¹ç†ç”±å¼¹çª— - æ”¹ä¸ºæ˜¾ç¤ºç¤¾ç¾¤ä¿¡æ¯
   */
  showPairModal: function(e) {
    const openid = e.currentTarget.dataset.openid;
    const user = this.data.communityMembers.find(u => u.openid === openid);
    const currentUserCommunity = this.data.currentUserCommunity;
    
    let modalContent = '';
    if (currentUserCommunity) {
      modalContent = `ç¤¾ç¾¤ï¼š${currentUserCommunity.name}\n\næè¿°ï¼š${currentUserCommunity.description}`;
      if (user && user.userInfo) {
        modalContent += `\n\nä¸ ${user.userInfo.nickName} åŒå±ä¸€ä¸ªç¤¾ç¾¤ï¼Œä½ ä»¬æœ‰ç›¸ä¼¼çš„ç‰¹è´¨å’Œå…´è¶£ï¼`;
      }
    } else {
      modalContent = 'æš‚æ— ç¤¾ç¾¤ä¿¡æ¯';
    }
    
    this.setData({
      showPairModal: true,
      pairModalContent: modalContent,
      pairModalUser: user
    });
  },
  closePairModal: function() {
    this.setData({ showPairModal: false });
  },

  /**
   * æ˜¾ç¤ºè¯¦ç»†åç‰‡
   */
  showDetailedCard: function(e) {
    const memberIndex = e.currentTarget.dataset.memberIndex;
    const selectedCard = this.data.selectedCard;
    
    if (!selectedCard.pairedUsers || memberIndex >= selectedCard.pairedUsers.length) {
      console.error('æˆå‘˜ç´¢å¼•æ— æ•ˆ:', memberIndex);
      wx.showToast({
        title: 'æˆå‘˜ä¿¡æ¯å¼‚å¸¸',
        icon: 'none'
      });
      return;
    }
    
    const selectedMember = selectedCard.pairedUsers[memberIndex];
    
    console.log('=== æ˜¾ç¤ºè¯¦ç»†åç‰‡ ===');
    console.log('æˆå‘˜ç´¢å¼•:', memberIndex);
    console.log('é€‰ä¸­æˆå‘˜:', selectedMember);
    
    this.setData({
      showDetailedCard: true,
      selectedMember: selectedMember
    });
    
    console.log('æ˜¾ç¤ºè¯¦ç»†åç‰‡å¼¹çª—:', {
      ç”¨æˆ·æ˜µç§°: selectedMember.userInfo?.nickName,
      ç”¨æˆ·openid: selectedMember.openid
    });
  },

  /**
   * å…³é—­è¯¦ç»†åç‰‡å¼¹çª—
   */
  closeDetailedCard: function() {
    this.setData({
      showDetailedCard: false,
      selectedMember: {}
    });
  },

  /**
   * å‘é€æ¶ˆæ¯ï¼ˆé¢„ç•™åŠŸèƒ½ï¼‰
   */
  sendMessage: function(e) {
    const openid = e.currentTarget.dataset.openid;
    console.log('å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·:', openid);
    
    // è¿™é‡Œå¯ä»¥åç»­æ·»åŠ å‘é€æ¶ˆæ¯åŠŸèƒ½
    wx.showToast({
      title: 'æ¶ˆæ¯åŠŸèƒ½å¼€å‘ä¸­',
      icon: 'none'
    });
  },

  /**
   * æŸ¥çœ‹ç¤¾ç¾¤è¯¦æƒ…ï¼ˆé¢„ç•™åŠŸèƒ½ï¼‰
   */
  viewCommunity: function() {
    console.log('æŸ¥çœ‹ç¤¾ç¾¤è¯¦æƒ…');
    
    // å¯ä»¥è·³è½¬åˆ°ç¤¾ç¾¤è¯¦æƒ…é¡µé¢æˆ–è€…æ˜¾ç¤ºæ›´å¤šä¿¡æ¯
    wx.showToast({
      title: 'ç¤¾ç¾¤è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­',
      icon: 'none'
    });
  }
})