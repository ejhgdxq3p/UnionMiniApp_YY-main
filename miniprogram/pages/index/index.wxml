<!--é«˜çº§æ ‡ç­¾é—®å·è°ƒæŸ¥é¡µé¢-->
<view class="container">
  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="content">
    <!-- æœªç™»å½•çŠ¶æ€ -->
    <block wx:if="{{!hasUserInfo}}">
      <view class="login-section">
        <view class="welcome-title">{{texts.welcomeTitle}}</view>
        <view class="welcome-desc">{{texts.welcomeDesc}}</view>
        <button class="login-btn" bindtap="login">{{texts.loginButton}}</button>
      </view>
    </block>

    <!-- å·²ç™»å½•çŠ¶æ€ -->
    <block wx:else>
      
      <!-- ä¸ªäººåç‰‡è§†å›¾ -->
      <view wx:if="{{viewMode === 'profile'}}" class="profile-card-view">
        
        <!-- åç‰‡å¤´éƒ¨ -->
        <view class="profile-header">
          <view class="profile-avatar-container">
            <image class="profile-avatar" src="{{userInfo.customAvatar && userInfo.avatarUrl ? userInfo.avatarUrl : 'https://api.dicebear.com/7.x/bottts-neutral/svg?seed=' + (advancedTags.displayName || userInfo.nickName || 'default')}}"></image>
          </view>
          <view class="profile-info">
            <view class="profile-name">{{advancedTags.displayName || userInfo.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</view>
            <view class="profile-subtitle">UnionLink æ•°å­—èº«ä»½</view>
          </view>
        </view>

        <!-- ç¼–ç ä¿¡æ¯å¡ç‰‡ - éšè— -->
        <!-- <view class="encoding-card">
          <view class="encoding-header">
            <view class="encoding-title">ğŸ” ä½ çš„æ ‡ç­¾ç¼–ç </view>
            <view class="encoding-stats">{{encodingInfo.selectedCount}}/{{encodingInfo.totalTags}} æ ‡ç­¾</view>
          </view>
          <view class="encoding-display">
            <text class="encoding-text" selectable="true">{{encodingInfo.encoded}}</text>
          </view>
          <view class="encoding-info">
            <text class="encoding-length">{{encodingInfo.length}} å­—ç¬¦ â€¢ é€‚ç”¨äºç¡¬ä»¶è®¾å¤‡å¿«é€Ÿé…å¯¹</text>
          </view>
        </view> -->

        <!-- æ ‡ç­¾å±•ç¤ºåŒºåŸŸ -->
        <view class="tags-display-section">
          
          <!-- ä¸“ä¸šé¢†åŸŸæ ‡ç­¾ -->
          <view wx:if="{{advancedTags.professionalTags.length > 0}}" class="tag-group">
            <view class="tag-group-title">ğŸ’¼ ä¸“ä¸šé¢†åŸŸ</view>
            <view class="tag-group-content">
              <view wx:for="{{advancedTags.professionalTags}}" wx:key="*this" class="display-tag prof-tag">
                {{item}}
              </view>
            </view>
          </view>

          <!-- å…´è¶£çˆ±å¥½æ ‡ç­¾ -->
          <view wx:if="{{advancedTags.interestTags.length > 0}}" class="tag-group">
            <view class="tag-group-title">ğŸ¨ å…´è¶£çˆ±å¥½</view>
            <view class="tag-group-content">
              <view wx:for="{{advancedTags.interestTags}}" wx:key="*this" class="display-tag hobby-tag">
                {{item}}
              </view>
            </view>
          </view>

          <!-- æ€§æ ¼ç‰¹å¾æ ‡ç­¾ -->
          <view wx:if="{{advancedTags.personalityTags.length > 0}}" class="tag-group">
            <view class="tag-group-title">ğŸ§  MBTIæ€§æ ¼</view>
            <view class="tag-group-content">
              <view wx:for="{{advancedTags.personalityTags}}" wx:key="*this" class="display-tag personality-tag">
                {{item}}
              </view>
            </view>
          </view>

          <!-- ç‰¹è´¨æ ‡ç­¾ -->
          <view wx:if="{{advancedTags.quirkyTags.length > 0}}" class="tag-group">
            <view class="tag-group-title">âœ¨ æ€§æ ¼å…³é”®è¯ / æ˜Ÿåº§ / å½©è›‹</view>
            <view class="tag-group-content">
              <view wx:for="{{advancedTags.quirkyTags}}" wx:key="*this" class="display-tag quirky-tag">
                {{item}}
              </view>
            </view>
          </view>
        </view>

        <!-- ä¸ªäººä¿¡æ¯åŒºåŸŸ -->
        <view class="personal-info-section">
          
          <!-- è”ç³»æ–¹å¼ -->
          <view wx:if="{{advancedTags.contactInfo}}" class="info-item">
            <view class="info-label">ğŸ“ è”ç³»æ–¹å¼</view>
            <view class="info-content">{{advancedTags.contactInfo}}</view>
          </view>

          <!-- ä¸ªæ€§æ ‡ç­¾ -->
          <view wx:if="{{advancedTags.personalTagsText}}" class="info-item">
            <view class="info-label">ğŸ·ï¸ ä¸ªæ€§æ ‡ç­¾</view>
            <view class="info-content">{{advancedTags.personalTagsText}}</view>
          </view>

          <!-- äºŒç»´ç  -->
          <view wx:if="{{advancedTags.qrCodeUrl}}" class="info-item qr-section">
            <view class="info-label">ğŸ’¬ å¾®ä¿¡äºŒç»´ç </view>
            <image class="qr-code-display" src="{{advancedTags.qrCodeUrl}}" mode="aspectFit"></image>
          </view>

          <!-- ä¸ªäººç…§ç‰‡ -->
          <view wx:if="{{advancedTags.photos.length > 0}}" class="info-item photos-section">
            <view class="info-label">ğŸ“· è„¸ç›²å‹å¥½è¡Œä¸ºğŸ¤</view>
            <view class="photos-display">
              <image wx:for="{{advancedTags.photos}}" wx:key="*this" 
                     class="photo-display" 
                     src="{{item}}" 
                     mode="aspectFill"></image>
            </view>
          </view>

          <!-- é—ªå…‰é˜ˆå€¼ -->
          <view class="info-item">
            <view class="info-label">ğŸ”¥ é—ªå…‰é˜ˆå€¼</view>
            <view class="info-content">{{advancedTags.threshold}} ä¸ªæ ‡ç­¾ç›¸åŒå³é—ªå…‰</view>
          </view>

        </view>

        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
        <view class="profile-actions">
          <button class="action-btn share-btn" bindtap="shareProfile">
            ğŸ“¤ åˆ†äº«åç‰‡
          </button>
          <button class="action-btn briefing-btn" bindtap="goToBriefing">
            ğŸ›ï¸ æŸ¥çœ‹ç¤¾ç¾¤
          </button>
        </view>

      </view>

      <!-- é—®å·ç¼–è¾‘è§†å›¾ -->
      <view wx:else class="questionnaire-view">
        <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
        <view class="user-header">
          <view class="avatar-container" bindtap="uploadAvatar">
            <image class="user-avatar" src="{{userInfo.customAvatar && userInfo.avatarUrl ? userInfo.avatarUrl : 'https://api.dicebear.com/7.x/bottts-neutral/svg?seed=' + (advancedTags.displayName || userInfo.nickName || 'default')}}"></image>
            <view class="avatar-upload-tip">{{texts.avatarUploadTip}}</view>
          </view>
          <view class="user-name">{{advancedTags.displayName || userInfo.nickName || 'å¾®ä¿¡ç”¨æˆ·'}}</view>
        </view>

        <!-- è¿›åº¦æ¡ -->
        <view class="progress-bar">
          <view class="progress" style="width: {{(currentStep / totalSteps) * 100}}%;"></view>
        </view>
        <view class="progress-text">{{texts.stepFormat.replace('{current}', currentStep).replace('{total}', totalSteps)}}</view>
        
        <!-- æ ‡ç­¾ç»Ÿè®¡ä¿¡æ¯ -->
        <view class="tags-summary">
          <view class="total-tags">å·²é€‰æ‹©æ ‡ç­¾ï¼š{{totalSelectedTags}} ä¸ª</view>
          <view wx:if="{{totalSelectedTags >= 4}}" class="tags-status success">âœ“ å·²è¾¾åˆ°æœ€ä½è¦æ±‚</view>
          <view wx:else class="tags-status warning">è¿˜éœ€é€‰æ‹© {{4 - totalSelectedTags}} ä¸ªæ ‡ç­¾</view>
        </view>

        <!-- é—®å·å†…å®¹ -->
        <form class="questionnaire-form">
          
          <!-- ç¬¬1æ­¥ï¼šä¸“ä¸šé¢†åŸŸæ ‡ç­¾ -->
          <view wx:if="{{currentStep === 1 && currentStepConfig}}" class="step-content">
            <view class="step-header">
              <view class="step-title">{{currentStepConfig.title}}</view>
              <view class="step-subtitle">{{currentStepConfig.subtitle}}</view>
              <view class="step-description">{{currentStepConfig.description}}</view>
            </view>
            
            <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
            <view class="category-selector">
              <view class="category-tabs">
                <view wx:for="{{currentStepConfig.categories}}" 
                      wx:key="name" 
                      wx:for-item="category"
                      class="category-tab {{currentCategory[1] === category.name ? 'active' : ''}}"
                      data-category="{{category.name}}"
                      bindtap="onCategorySelect">
                  {{category.name}}
                </view>
              </view>
            </view>
            
            <!-- å½“å‰åˆ†ç±»ä¸‹çš„æ ‡ç­¾ -->
            <view class="current-category-tags">
              <view class="category-title">{{currentCategory[1]}}</view>
              <view wx:for="{{currentStepConfig.categories}}" 
                    wx:key="name" 
                    wx:for-item="category"
                    wx:if="{{category.name === currentCategory[1] && category.note}}"
                    class="category-note">
                {{category.note}}
              </view>
              <view class="tags-grid">
                <block wx:for="{{tagOptions.professional}}" wx:key="name" wx:for-item="tagOption">
                  <view wx:if="{{tagOption.category === currentCategory[1]}}" 
                        class="tag-btn {{tagOption.active ? 'active' : ''}}" 
                        data-value="{{tagOption.name}}" 
                        bindtap="onProfessionalTagToggle">
                    {{tagOption.name}}
                  </view>
                </block>
              </view>
            </view>
          </view>

          <!-- ç¬¬2æ­¥ï¼šå…´è¶£çˆ±å¥½æ ‡ç­¾ -->
          <view wx:if="{{currentStep === 2 && currentStepConfig}}" class="step-content">
            <view class="step-header">
              <view class="step-title">{{currentStepConfig.title}}</view>
              <view class="step-subtitle">{{currentStepConfig.subtitle}}</view>
              <view class="step-description">{{currentStepConfig.description}}</view>
            </view>
            
            <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
            <view class="category-selector">
              <view class="category-tabs">
                <view wx:for="{{currentStepConfig.categories}}" 
                      wx:key="name" 
                      wx:for-item="category"
                      class="category-tab {{currentCategory[2] === category.name ? 'active' : ''}}"
                      data-category="{{category.name}}"
                      bindtap="onCategorySelect">
                  {{category.name}}
                </view>
              </view>
            </view>
            
            <!-- å½“å‰åˆ†ç±»ä¸‹çš„æ ‡ç­¾ -->
            <view class="current-category-tags">
              <view class="category-title">{{currentCategory[2]}}</view>
              <view wx:for="{{currentStepConfig.categories}}" 
                    wx:key="name" 
                    wx:for-item="category"
                    wx:if="{{category.name === currentCategory[2] && category.note}}"
                    class="category-note">
                {{category.note}}
              </view>
              <view class="tags-grid">
                <block wx:for="{{tagOptions.interest}}" wx:key="name" wx:for-item="tagOption">
                  <view wx:if="{{tagOption.category === currentCategory[2]}}" 
                        class="tag-btn {{tagOption.active ? 'active' : ''}}" 
                        data-value="{{tagOption.name}}" 
                        bindtap="onInterestTagToggle">
                    {{tagOption.name}}
                  </view>
                </block>
              </view>
            </view>
          </view>

          <!-- ç¬¬3æ­¥ï¼šMBTIæ€§æ ¼æ ‡ç­¾ -->
          <view wx:if="{{currentStep === 3 && currentStepConfig}}" class="step-content">
            <view class="step-header">
              <view class="step-title">{{currentStepConfig.title}}</view>
              <view class="step-subtitle">{{currentStepConfig.subtitle}}</view>
              <view class="step-description">{{currentStepConfig.description}}</view>
            </view>
            
            <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
            <view class="category-selector">
              <view class="category-tabs">
                <view wx:for="{{currentStepConfig.categories}}" 
                      wx:key="name" 
                      wx:for-item="category"
                      class="category-tab {{currentCategory[3] === category.name ? 'active' : ''}}"
                      data-category="{{category.name}}"
                      bindtap="onCategorySelect">
                  {{category.name}}
                </view>
              </view>
            </view>
            
            <!-- å½“å‰åˆ†ç±»ä¸‹çš„æ ‡ç­¾ -->
            <view class="current-category-tags">
              <view class="category-title">{{currentCategory[3]}}</view>
              <view wx:for="{{currentStepConfig.categories}}" 
                    wx:key="name" 
                    wx:for-item="category"
                    wx:if="{{category.name === currentCategory[3] && category.note}}"
                    class="category-note">
                {{category.note}}
              </view>
              <view class="tags-grid">
                <block wx:for="{{tagOptions.personality}}" wx:key="name" wx:for-item="tagOption">
                  <view wx:if="{{tagOption.category === currentCategory[3]}}" 
                        class="tag-btn {{tagOption.active ? 'active' : ''}}" 
                        data-value="{{tagOption.name}}" 
                        bindtap="onPersonalityTagToggle">
                    {{tagOption.name}}
                  </view>
                </block>
              </view>
            </view>
          </view>

          <!-- ç¬¬4æ­¥ï¼šä¸ªäººä¿¡æ¯è®¾ç½® -->
          <view wx:if="{{currentStep === 4 && currentStepConfig}}" class="step-content">
            <view class="step-header">
              <view class="step-title">{{currentStepConfig.title}}</view>
              <view class="step-subtitle">{{currentStepConfig.subtitle}}</view>
              <view class="step-description">{{currentStepConfig.description}}</view>
            </view>
            
            <view class="contact-form">
              <!-- æ˜¾ç¤ºåç§° -->
              <view class="form-item">
                <view class="form-label required">ä½ å¸Œæœ›çº¿ä¸‹å’Œä½ äº’æ¢äº†ä¿¡æ¯çš„æœ‹å‹æ€ä¹ˆç§°å‘¼ä½ </view>
                <input class="form-input" 
                       placeholder="é»˜è®¤æ˜¯å¾®ä¿¡æ˜µç§°" 
                       value="{{advancedTags.displayName}}" 
                       data-field="displayName"
                       bindinput="onContactInput" />
              </view>

              <!-- äºŒç»´ç ä¸Šä¼  -->
              <view class="form-item">
                <view class="form-label">å¾®ä¿¡äºŒç»´ç </view>
                <view class="upload-section">
                  <view wx:if="{{!advancedTags.qrCodeUrl}}" class="upload-btn" bindtap="uploadQRCode">
                    <view class="upload-icon">ğŸ“·</view>
                    <view class="upload-text">ä¸Šä¼ å¾®ä¿¡äºŒç»´ç å›¾ç‰‡</view>
                  </view>
                  <view wx:else class="uploaded-image">
                    <image src="{{advancedTags.qrCodeUrl}}" mode="aspectFit"></image>
                    <view class="reupload-btn" bindtap="uploadQRCode">é‡æ–°ä¸Šä¼ </view>
                  </view>
                </view>
              </view>

              <!-- è”ç³»æ–¹å¼ -->
              <view class="form-item">
                <view class="form-label">è”ç³»æ–¹å¼</view>
                <input class="form-input" 
                       placeholder="å¾®ä¿¡å·ã€ç”µè¯å·ç ç­‰" 
                       value="{{advancedTags.contactInfo}}" 
                       data-field="contactInfo"
                       bindinput="onContactInput" />
              </view>

              <!-- ä¸ªæ€§æ ‡ç­¾ -->
              <view class="form-item">
                <view class="form-label">ä¸ªæ€§tag</view>
                <textarea class="form-textarea" 
                          placeholder="å¦‚ï¼šä¸å–å’–å•¡ä¼šæ­»æ˜Ÿäºº" 
                          value="{{advancedTags.personalTagsText}}" 
                          data-field="personalTagsText"
                          bindinput="onContactInput"
                          maxlength="200"></textarea>
              </view>

              <!-- é—ªå…‰é˜ˆå€¼ä¿¡æ¯ -->
              <view class="form-item">
                <view class="form-label">ğŸ”¥ é—ªå…‰é˜ˆå€¼</view>
                <view class="threshold-info">
                  <view class="threshold-display-simple">
                    <text class="threshold-number-simple">{{advancedTags.threshold}}</text>
                    <text class="threshold-text-simple">ä¸ªæ ‡ç­¾ç›¸åŒå³é—ªå…‰</text>
                  </view>
                  <view class="threshold-hint">ç³»ç»Ÿé»˜è®¤è®¾ç½®ï¼Œå¯åœ¨æäº¤åè°ƒæ•´</view>
                </view>
              </view>
            </view>
          </view>

          <!-- ç¼–ç æµ‹è¯•æŒ‰é’®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ -->
          <view wx:if="{{currentStep === 1}}" class="debug-section">
            <button class="test-btn" bindtap="testEncoding" type="primary" size="mini">æµ‹è¯•ç¼–ç åŠŸèƒ½</button>
          </view>

          <!-- ç¬¬5æ­¥ï¼šæ€§æ ¼å…³é”®è¯ / æ˜Ÿåº§ / å½©è›‹æ ‡ç­¾ -->
          <view wx:if="{{currentStep === 5 && currentStepConfig}}" class="step-content">
            <view class="step-header">
              <view class="step-title">{{currentStepConfig.title}}</view>
              <view class="step-subtitle">{{currentStepConfig.subtitle}}</view>
              <view class="step-description">{{currentStepConfig.description}}</view>
            </view>
            
            <!-- åˆ†ç±»é€‰æ‹©åŒºåŸŸ -->
            <view class="category-selector">
              <view class="category-tabs">
                <view wx:for="{{currentStepConfig.categories}}" 
                      wx:key="name" 
                      wx:for-item="category"
                      class="category-tab {{currentCategory[5] === category.name ? 'active' : ''}}"
                      data-category="{{category.name}}"
                      bindtap="onCategorySelect">
                  {{category.name}}
                </view>
              </view>
            </view>
            
            <!-- å½“å‰åˆ†ç±»ä¸‹çš„æ ‡ç­¾ -->
            <view class="current-category-tags">
              <view class="category-title">{{currentCategory[5]}}</view>
              <view wx:for="{{currentStepConfig.categories}}" 
                    wx:key="name" 
                    wx:for-item="category"
                    wx:if="{{category.name === currentCategory[5] && category.note}}"
                    class="category-note">
                {{category.note}}
              </view>
              <view class="tags-grid">
                <block wx:for="{{tagOptions.quirky}}" wx:key="name" wx:for-item="tagOption">
                  <view wx:if="{{tagOption.category === currentCategory[5]}}" 
                        class="tag-btn quirky-tag {{tagOption.active ? 'active' : ''}}" 
                        data-value="{{tagOption.name}}" 
                        bindtap="onQuirkyTagToggle">
                    {{tagOption.name}}
                  </view>
                </block>
              </view>
            </view>
          </view>

        </form>

        <!-- åº•éƒ¨å¯¼èˆªæŒ‰é’® -->
        <view class="nav-buttons">
          <button wx:if="{{currentStep > 1}}" 
                  class="prev-btn" 
                  bindtap="prevStep">
            {{texts.prevButton}}
          </button>

          <view class="nav-spacer"></view>

          <button wx:if="{{currentStep < totalSteps}}" 
                  class="next-btn" 
                  bindtap="nextStep">
            {{texts.nextButton}}
          </button>

          <button wx:if="{{currentStep === totalSteps}}" 
                  class="submit-btn {{isSubmitting ? 'submitting' : ''}}" 
                  bindtap="submitForm"
                  disabled="{{isSubmitting}}">
            {{isSubmitting ? 'æäº¤ä¸­...' : texts.submitButton}}
          </button>
        </view>
      </view>
    </block>
  </view>
  
  <!-- æµ®åŠ¨ç¼–è¾‘æŒ‰é’® (ä»…åœ¨ä¸ªäººåç‰‡è§†å›¾æ˜¾ç¤º) -->
  <view wx:if="{{hasUserInfo && viewMode === 'profile'}}" class="floating-edit-btn" bindtap="switchToQuestionnaireView">
    <view class="edit-icon">âœï¸</view>
    <view class="edit-hint">ç¼–è¾‘</view>
  </view>
</view> 